<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotto Genius Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                        accent: '#10B981',
                        dark: '#1F2937',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles for body and typography */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Sidebar transition for smooth hide/show */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* Chart container to manage max height and responsiveness */
        .chart-container {
            max-height: 200px; /* Limits height for smaller screens, responsive width */
            width: 100%; /* Ensures charts take full available width */
        }
        /* Styling for number balls */
        .number-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px; /* Slightly larger for better touch target */
            height: 36px; /* Slightly larger for better touch target */
            border-radius: 50%;
            background-color: #3B82F6;
            color: white;
            font-weight: bold;
            margin: 4px; /* Increased margin for better spacing on mobile */
            flex-shrink: 0; /* Prevent shrinking on small screens */
        }
        .bonus-ball {
            background-color: #8B5CF6;
        }
        .hot-number {
            background-color: #EF4444;
        }
        .cold-number {
            background-color: #3B82F6;
        }
        .due-number {
            background-color: #F59E0B;
        }
        /* New style for unused numbers/pairs */
        .unused-number {
            background-color: #6B7280; /* Gray for unused */
        }

        /* Responsive adjustments for main content area */
        @media (min-width: 768px) { /* md breakpoint */
            .main-content-area {
                margin-left: 16rem; /* Equivalent to md:ml-64 */
            }
        }
        /* General button styling for better touch targets */
        button {
            padding: 0.75rem 1rem; /* Increase padding for better touch area */
            border-radius: 0.5rem; /* More rounded corners */
            font-weight: 500; /* Medium font weight */
            transition: background-color 0.2s ease-in-out;
        }
        /* Textarea and input styling for consistency */
        textarea, input[type="text"], input[type="number"], select {
            padding: 0.6rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB; /* Light gray border */
        }
        .dark textarea, .dark input[type="text"], .dark input[type="number"], .dark select {
            border-color: #4B5563; /* Darker border in dark mode */
        }
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg p-4 sidebar z-40 md:translate-x-0 sidebar-hidden">
        <div class="flex items-center mb-6">
            <h1 class="text-2xl font-bold text-primary">Lotto Genius</h1>
            <span class="ml-2 px-2 py-1 text-xs bg-accent text-white rounded-full">PRO</span>
        </div>
        <nav>
            <ul class="space-y-2">
                <li><a href="#dashboard" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📊 Dashboard</a></li>
                <li><a href="#generator" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🎰 Smart Generator</a></li>
                <li><a href="#analyzer" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔍 Advanced Analyzer</a></li>
                <li><a href="#combinatorics" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔬 Combinatorics Lab</a></li>
                <li><a href="#reverse-engineer" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔄 Reverse Engineer</a></li>
                <li><a href="#historical" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📈 Historical Data</a></li>
                <li><a href="#strategies" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🧠 AI Strategies</a></li>
                <li><a href="#probability" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">📉 Probability Lab</a></li>
                <li><a href="#prediction" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">🔮 Prediction Engine</a></li>
                <li><a href="#settings" class="flex items-center p-2 text-primary hover:bg-primary hover:text-white rounded">⚙️ Settings</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="ml-0 p-4 main-content-area">
        <header class="flex justify-between items-center mb-6">
            <button id="toggleSidebar" class="md:hidden p-2 bg-primary text-white rounded-lg">☰</button>
            <div class="flex space-x-4">
                <button id="themeToggle" class="p-2 bg-primary text-white rounded-lg">🌙 Toggle Theme</button>
                <button id="notifications" class="p-2 bg-secondary text-white rounded-lg relative">
                    🔔 Notifications
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </header>

        <main class="space-y-6">
            <!-- Dashboard Section -->
            <section id="dashboard" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Recent Activity</h3>
                        <div id="recentActivity" class="text-sm">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Quick Actions</h3>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-action p-2 bg-primary text-white rounded-lg text-sm" data-action="quickPick">Quick Pick</button>
                            <button class="quick-action p-2 bg-secondary text-white rounded-lg text-sm" data-action="analyzeLast">Analyze Last</button>
                            <button class="quick-action p-2 bg-accent text-white rounded-lg text-sm" data-action="checkOdds">Check Odds</button>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-medium mb-2">Statistics</h3>
                        <div id="statsOverview" class="text-sm">
                            <p>Generate numbers to see statistics</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency Heatmap</h3>
                        <canvas id="dashboardHeatmap" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Recent Patterns</h3>
                        <canvas id="dashboardPatterns" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- Smart Generator Section -->
            <section id="generator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Smart Number Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Game Configuration -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Game Setup</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Lottery Game</label>
                            <select id="lotteryGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="mainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="pickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="bonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="bonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Random Seed</label>
                            <div class="flex gap-2">
                                <input id="randomSeed" type="text" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="Enter seed">
                                <button id="randomSeedBtn" class="p-2 bg-primary text-white rounded-lg">🎲 Random</button>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Options -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Generation Method</h3>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Algorithm</label>
                            <select id="generationMethod" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="standard">Standard Random</option>
                                <option value="fisherYates">Fisher-Yates Shuffle</option>
                                <option value="crypto">Cryptographically Secure</option>
                                <option value="lowHigh">Low-High Balance</option>
                                <option value="oddEven">Odd-Even Balance</option>
                                <option value="prime">Prime Number Filter</option>
                                <option value="fibonacci">Fibonacci Filter</option>
                                <option value="statistical">Statistical Weighted</option>
                                <option value="ai">AI-Powered ✨</option>
                                <option value="quantumInspired">Quantum-Inspired ⚛️</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Historical Filters</label>
                            <div class="space-y-1">
                                <label class="flex items-center"><input id="useHistorical" type="checkbox" class="mr-2"> Use Historical Data</label>
                                <label class="flex items-center"><input id="favorHot" type="checkbox" class="mr-2"> Favor Hot Numbers</label>
                                <label class="flex items-center"><input id="includeDue" type="checkbox" class="mr-2"> Include Due Numbers</label>
                                <label class="flex items-center"><input id="avoidRepeats" type="checkbox" class="mr-2"> Avoid Recent Repeats</label>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Advanced Options</h3>
                        <div>
                            <label class="block text-sm font-medium">Number of Tickets</label>
                            <input id="numTickets" type="number" min="1" max="100" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Sum Filter</label>
                            <select id="sumFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Sum</option>
                                <option value="low">Low Sum</option>
                                <option value="medium">Medium Sum</option>
                                <option value="high">High Sum</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Consecutive Numbers</label>
                            <select id="consecutiveFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="any">Any Consecutives</option>
                                <option value="none">No Consecutives</option>
                                <option value="max1">Max 1 Pair</option>
                                <option value="max2">Max 2 Pairs</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">Quick Actions</h3>
                    <div class="flex flex-wrap gap-2">
                        <button id="generateSmart" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700">Generate Smart Numbers</button>
                        <button id="quickPick" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Quick Pick (Random)</button>
                        <button id="generateWheeling" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700">Generate Wheeling System</button>
                        <button id="clearGenerator" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear All</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Tip: Combine AI-Powered generation with historical data for statistically optimized numbers.</p>
                </div>

                <!-- Generated Tickets -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-medium">Generated Tickets</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="exportTxt" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">TXT</button>
                            <button id="exportCsv" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">CSV</button>
                            <button id="copyTickets" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                            <button id="saveTickets" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 text-sm">Save</button>
                        </div>
                    </div>
                    <div id="generatedTickets" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20">
                        <p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>
                    </div>
                </div>

                <!-- Analysis Panels -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Number Frequency</h3>
                        <canvas id="numberFrequencyChart" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Sum Analysis</h3>
                        <canvas id="sumAnalysisChart" class="chart-container"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Pattern Analysis</h3>
                        <canvas id="patternAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- Advanced Analyzer Section -->
            <section id="analyzer" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Number Analyzer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Analysis Input -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="analyzerGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option> <!-- Added Custom Game option -->
                            </select>
                        </div>
                        
                        <!-- Custom Game Configuration for Analyzer -->
                        <div id="customAnalyzerGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="analyzerMainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="analyzerPickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="analyzerBonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="analyzerBonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Numbers to Analyze</label>
                            <textarea id="numbersToAnalyze" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: 5,12,23,34,45,6 or 5 12 23 34 45 6 or 5-12-23-34-45-6</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="analyzeNumbers" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Analyze</button>
                            <button id="getAIInsights" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 flex-1">AI Insights ✨</button>
                            <button id="clearAnalyzer" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Sample Inputs</h4>
                            <div class="text-xs space-y-1 mt-1">
                                <button class="sample-input text-primary hover:underline" data-sample="5,12,23,34,45,6">Powerball</button><br>
                                <button class="sample-input text-primary hover:underline" data-sample="3,18,29,41,52,15">Mega Millions</button><br>
                                <button class="sample-input text-primary hover:underline" data-sample="7,14,21,28,35">Lotto 6/49</button>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Analysis Results -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Basic Analysis</h3>
                        <div id="analysisResults" class="p-4 bg-gray-10- dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Number Properties</h4>
                                <div id="numberProps" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Pattern Analysis</h4>
                                <div id="patternStats" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <!-- AI Insights Output -->
                        <div id="aiInsightsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">AI Insights</h4>
                            <div id="aiInsightsText" class="text-xs mt-1"></div>
                            <div id="aiInsightsLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                    </div>

                    <!-- Advanced Analysis -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-medium">Advanced Metrics</h3>
                            <button id="exportAnalysis" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Basic Statistics</h4>
                                <div id="basicStats" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Advanced Metrics</h4>
                                <div id="advancedMetrics" class="text-xs mt-1"></div>
                            </div>
                            <!-- New section for most used numbers from input -->
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Most Used Numbers (from input)</h4>
                                <div id="mostUsedNumbersInput" class="text-xs mt-1">
                                    <p>Analyze numbers to see the most frequently entered numbers.</p>
                                </div>
                            </div>
                            <!-- New section for least used numbers from input -->
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Least Used Numbers (from input)</h4>
                                <div id="leastUsedNumbersInput" class="text-xs mt-1">
                                    <p>Analyze numbers to see the least frequently entered numbers.</p>
                                </div>
                            </div>
                            <!-- New section for unused numbers and pairs -->
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Unused Numbers & Pairs (from pool)</h4>
                                <div id="unusedNumbersAndPairs" class="text-xs mt-1">
                                    <p>Analyze numbers to see unused numbers and pairs relative to the game's pool.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Number Frequency</h4>
                            <canvas id="freqDistributionChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Analysis Charts -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Last Digit Distribution</h4>
                        <canvas id="lastDigitDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Number Sum Distribution</h4>
                        <canvas id="sumDistributionChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Odd/Even Distribution</h4>
                        <canvas id="oddEvenDistributionChart" class="chart-container"></canvas>
                    </div>
                </div>

                <!-- Prediction Engine (Advanced) -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium">Prediction Engine (Advanced)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Prediction Algorithm</label>
                            <select id="advancedPredictionAlgorithm" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="fisherYatesEnhanced">Fisher-Yates Shuffle Enhanced</option>
                                <option value="cryptoSecureEnhanced">Cryptographically Secure Enhanced</option>
                                <option value="primeFilter">Prime Filter</option> <!-- New Prime Filter Option -->
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Advance Filter</label>
                            <select id="advanceFilter" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="balanced">Balanced (Default)</option>
                                <option value="favorUnused">Favor Unused</option>
                                <option value="favorMostUsed">Favor Most Used</option>
                                <option value="favorLeastUsed">Favor Least Used</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="predictAdvanced" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700">Predict</button>
                        <button id="regenerateAdvancedPrediction" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Regenerate Prediction</button>
                        <button id="clearAdvancedPrediction" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear Predictions</button>
                    </div>
                    <div id="advancedPredictionOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 mt-2">
                        <p class="text-gray-500 dark:text-gray-400">Generate advanced predictions to see results here.</p>
                        <div id="advancedPredictionLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                    </div>
                </div>
            </section>

            <!-- Combinatorics Lab Section -->
            <section id="combinatorics" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Combinatorics Lab</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Common Pairs Generator -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-primary">Common Pairs Generator</h3>
                        <div>
                            <label class="block text-sm font-medium">Draw Data Input</label>
                            <textarea id="pairsDataInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-40" placeholder="Enter historical draws, one per line (e.g., 5 12 23 34 45 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tip: Use data from the 'Historical Data' tab for best results.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="block text-sm font-medium">Min Frequency</label>
                            <input id="minPairFrequency" type="number" class="w-24 p-2 border rounded-lg dark:bg-gray-700" value="2">
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="findCommonPairs" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Find Common Pairs</button>
                            <button id="useHistoricalForPairs" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700">Use Loaded Data</button>
                            <button id="clearPairs" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium mb-2">Most Common Pairs</h4>
                            <div id="commonPairsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20">
                                <p class="text-gray-500 dark:text-gray-400">Find pairs to see results.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Combinations Generator -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-accent">Combinations Generator</h3>
                        <div>
                            <label class="block text-sm font-medium">Your Numbers</label>
                            <textarea id="comboNumbersInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-24" placeholder="Enter a set of numbers to combine (e.g., 1, 2, 3, 4, 5, 6, 7)"></textarea>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="block text-sm font-medium">Combination Size (r)</label>
                            <input id="combinationSize" type="number" class="w-24 p-2 border rounded-lg dark:bg-gray-700" value="3">
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="generateCombinations" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 flex-1">Generate Combinations</button>
                            <button id="clearCombinations" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-medium">Generated Combinations (<span id="combinationCount">0</span>)</h4>
                                <div class="flex gap-2">
                                    <button id="exportCombinationsTxt" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">TXT</button>
                                    <button id="copyCombinations" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Copy</button>
                                </div>
                            </div>
                            <div id="combinationsOutput" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-20 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 dark:text-gray-400">Generate combinations to see results.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reverse Engineer Section -->
            <section id="reverse-engineer" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Advanced Lotto Reverse Engineer</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Input Section -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Input Numbers</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="reverseGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Numbers to Reverse Engineer</label>
                            <textarea id="numbersToReverse" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter numbers (e.g., 5, 12, 23, 34, 45, 6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Formats: 5,12,23,34,45,6 or 5 12 23 34 45 6</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Analysis Method</label>
                            <select id="reverseMethod" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="statistical">Statistical Analysis</option>
                                <option value="pattern">Pattern Recognition</option>
                                <option value="ai">AI-Powered Reverse Engineering ✨</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="reverseEngineerBtn" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Reverse Engineer</button>
                            <button id="clearReverse" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Reverse Engineering Results</h3>
                        <div id="reverseResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg min-h-32">
                            <p class="text-gray-500 dark:text-gray-400">Enter numbers and analyze to see results</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Statistical Profile</h4>
                                <div id="reverseStats" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Pattern Analysis</h4>
                                <div id="reversePatterns" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Potential Seed Values</h4>
                            <div id="reverseSeeds" class="text-xs mt-1">
                                <p>Analyze numbers to see potential seed values</p>
                            </div>
                        </div>

                        <!-- New AI-powered sections -->
                        <div id="optimalCharacteristics" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">Optimal Game Characteristics ✨</h4>
                            <div id="optimalCharacteristicsText" class="text-xs mt-1"></div>
                            <div id="optimalCharacteristicsLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>

                        <div id="seedComparison" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="font-medium text-sm">Seed Comparison to Optimal ✨</h4>
                            <div id="seedComparisonText" class="text-xs mt-1"></div>
                            <div id="seedComparisonLoading" class="loading-indicator hidden mx-auto mt-2"></div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Visual Representation</h4>
                            <canvas id="reverseChart" class="chart-container"></canvas>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Seed Number Distribution</h4>
                            <canvas id="seedVisualsChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Historical Data Section -->
            <section id="historical" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Historical Data Explorer</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Data Configuration -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Source</h3>
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="historicalGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option> <!-- Added Custom Game option -->
                            </select>
                        </div>

                        <!-- Custom Game Configuration for Historical Data -->
                        <div id="customHistoricalGameConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="historicalMainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="historicalPickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="historicalBonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="historicalBonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Data Source</label>
                            <select id="dataSource" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="sample">Sample Data (Built-in)</option>
                                <option value="api">Live API (Premium)</option>
                                <option value="csv">Upload CSV</option>
                                <option value="manual">Manual Input</option> <!-- Added Manual Input option -->
                            </select>
                        </div>
                        
                        <div id="csvUploadContainer" class="hidden">
                            <label class="block text-sm font-medium">Upload CSV File</label>
                            <input id="csvUpload" type="file" accept=".csv" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">CSV format: Date,Number1,Number2,...,Bonus1,Bonus2</p>
                        </div>

                        <!-- Manual Input Container -->
                        <div id="manualInputContainer" class="hidden">
                            <label class="block text-sm font-medium">Enter Draws Manually</label>
                            <textarea id="manualDrawsInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 h-32" placeholder="Enter draws, one per line (e.g., 2023-01-01,5,12,23,34,45,6)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Format: Date,Number1,Number2,...,Bonus1,Bonus2</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Number of Past Draws</label>
                            <select id="pastDraws" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="10">10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">500</option>
                                <option value="all">All Available</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="loadData" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Load Data</button>
                            <button id="clearHistorical" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Clear</button>
                        </div>
                    </div>

                    <!-- Data Summary -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Summary</h3>
                        <div id="dataSummary" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Load historical data to see summary</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Most Frequent</h4>
                                <div id="mostFrequent" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Least Frequent</h4>
                                <div id="leastFrequent" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Due Numbers</h4>
                            <div id="dueNumbers" class="text-xs mt-1"></div>
                        </div>
                    </div>

                    <!-- Quick Analysis -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-medium">Quick Analysis</h3>
                            <button id="exportHistorical" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Recent Trends</h4>
                            <div id="recentTrends" class="text-xs mt-1"></div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Pattern Frequency</h4>
                            <div id="patternFrequency" class="text-xs mt-1"></div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Sum Statistics</h4>
                            <div id="sumStatistics" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Data Table -->
                <div class="mt-4">
                    <h3 class="text-xl font-medium mb-2">Historical Draws</h3>
                    <div class="overflow-x-auto">
                        <table id="historicalTable" class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200 dark:bg-gray-700">
                                    <th class="p-2 text-left">Date</th>
                                    <th class="p-2 text-left">Numbers</th>
                                    <th class="p-2 text-left">Bonus</th>
                                    <th class="p-2 text-left">Sum</th>
                                    <th class="p-2 text-left">Odd/Even</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr>
                                    <td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-2 gap-2">
                        <div class="text-sm text-gray-600 dark:text-gray-400" id="paginationInfo">Showing 0 of 0</div>
                        <div class="flex gap-2">
                            <button id="prevPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled><</button>
                            <button id="nextPage" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>></button>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Analysis Charts -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Number Frequency Heatmap</h4>
                        <canvas id="freqHeatmapChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Frequency Over Time</h4>
                        <canvas id="freqOverTimeChart" class="chart-container"></canvas>
                    </div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium text-sm">Gap Analysis</h4>
                        <canvas id="gapAnalysisChart" class="chart-container"></canvas>
                    </div>
                </div>
            </section>

            <!-- AI Strategies Section -->
            <section id="strategies" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">AI-Powered Strategies</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Strategy Cards -->
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-primary">
                        <h3 class="text-xl font-medium">Frequency Analysis</h3>
                        <p class="text-sm mt-2">Identifies hot (frequently drawn) and cold (rarely drawn) numbers based on historical data patterns.</p>
                        <button class="applyStrategy mt-4 p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full" data-strategy="frequency">Apply Strategy</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-secondary">
                        <h3 class="text-xl font-medium">Gap Analysis</h3>
                        <p class="text-sm mt-2">Finds numbers that are statistically "due" to be drawn based on the time since their last appearance.</p>
                        <button class="applyStrategy mt-4 p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 w-full" data-strategy="gap">Apply Strategy</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-accent">
                        <h3 class="text-xl font-medium">Pattern Recognition</h3>
                        <p class="text-sm mt-2">Detects number patterns and sequences that frequently occur in winning combinations.</p>
                        <button class="applyStrategy mt-4 p-2 bg-accent text-white rounded-lg hover:bg-green-700 w-full" data-strategy="pattern">Apply Strategy</button>
                    </div>
                </div>
                
                <!-- Custom Strategy Builder -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-4">Custom Strategy Builder</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium">Strategy Components</h4>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="frequency" checked> Number Frequency</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="gap" checked> Gap Analysis</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="pattern"> Pattern Recognition</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="sum"> Sum Analysis</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="prime"> Prime Numbers</label>
                                <label class="flex items-center"><input type="checkbox" class="strategyComponent mr-2" value="fibonacci"> Fibonacci Numbers</label>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium">Weighting</h4>
                            <div class="space-y-2 mt-2">
                                <div>
                                    <label class="block text-sm">Frequency Importance</label>
                                    <input id="freqWeight" type="range" min="0" max="100" value="40" class="w-full">
                                    <span id="freqWeightValue" class="text-xs">40%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Gap Importance</label>
                                    <input id="gapWeight" type="range" min="0" max="100" value="30" class="w-full">
                                    <span id="gapWeightValue" class="text-xs">30%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Pattern Importance</label>
                                    <input id="patternWeight" type="range" min="0" max="100" value="20" class="w-full">
                                    <span id="patternWeightValue" class="text-xs">20%</span>
                                </div>
                                <div>
                                    <label class="block text-sm">Other Importance</label>
                                    <input id="otherWeight" type="range" min="0" max="100" value="10" class="w-full">
                                    <span id="otherWeightValue" class="text-xs">10%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button id="buildStrategy" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full">Build & Apply Custom Strategy</button>
                    </div>
                </div>
                
                <!-- Strategy Results -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">Strategy Results</h3>
                    <div id="strategyResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-gray-500 dark:text-gray-400">Apply a strategy to see recommendations</p>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Recommended Numbers</h4>
                            <div id="recommendedNumbers" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Strategy Analysis</h4>
                            <div id="strategyAnalysis" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Probability Lab Section -->
            <section id="probability" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Probability Laboratory</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Calculator -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Probability Calculator</h3>
                        
                        <div>
                            <label class="block text-sm font-medium">Game Type</label>
                            <select id="probabilityGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball (5/69 + 1/26)</option>
                                <option value="megamillions">Mega Millions (5/70 + 1/25)</option>
                                <option value="euromillions">EuroMillions (5/50 + 2/12)</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                                <option value="custom">Custom Game</option>
                            </select>
                        </div>
                        
                        <div id="customProbabilityConfig" class="grid grid-cols-2 gap-2 hidden">
                            <div>
                                <label class="block text-sm font-medium">Main Pool</label>
                                <input id="probMainPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 69">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Pick Count</label>
                                <input id="probPickCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Pool</label>
                                <input id="probBonusPool" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 26">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Bonus Count</label>
                                <input id="probBonusCount" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Tickets to Play</label>
                            <input id="ticketsToPlay" type="number" min="1" max="1000000" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="1">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium">Jackpot Size ($)</label>
                                <input id="jackpotSize" type="number" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 1000000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Tax Rate (%)</label>
                                <input id="taxRate" type="number" min="0" max="100" class="w-full p-2 border rounded-lg dark:bg-gray-700" placeholder="e.g., 30">
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button id="calculateProb" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Calculate</button>
                            <button id="resetProb" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600">Reset</button>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-medium">Probability Results</h3>
                            <button id="exportProb" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                        </div>
                        
                        <div id="probResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-gray-500 dark:text-gray-400">Calculate probabilities to see results</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Basic Probabilities</h4>
                                <div id="basicProbs" class="text-xs mt-1"></div>
                            </div>
                            <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <h4 class="font-medium text-sm">Winning Chances</h4>
                                <div id="winChances" class="text-xs mt-1"></div>
                            </div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Expected Value</h4>
                            <div id="expectedValue" class="text-lg font-bold mt-1">$0.00</div>
                        </div>
                        
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Probability Distribution</h4>
                            <canvas id="probDistributionChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Probability Analysis -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">Advanced Probability Analysis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Probability Comparisons</h4>
                            <div id="probComparisons" class="text-xs mt-1"></div>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Investment Analysis</h4>
                            <div id="investmentAnalysis" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Prediction Engine Section -->
            <section id="prediction" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">AI Prediction Engine</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Prediction Cards -->
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-primary">
                        <h3 class="text-xl font-medium">Next Draw Prediction</h3>
                        <p class="text-sm mt-2">Our AI analyzes historical patterns and trends to predict the most likely numbers for the next draw.</p>
                        <button id="generatePrediction" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 mt-4 w-full">Generate Prediction</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-secondary">
                        <h3 class="text-xl font-medium">Multiple Draw Forecast</h3>
                        <p class="text-sm mt-2">Get predictions for several upcoming draws with confidence scores for each number.</p>
                        <button id="forecastDraws" class="p-2 bg-secondary text-white rounded-lg hover:bg-purple-700 mt-4 w-full">Forecast Next 40 Draws</button>
                    </div>
                    
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-accent">
                        <h3 class="text-xl font-medium">Custom Prediction</h3>
                        <p class="text-sm mt-2">Configure specific parameters for the AI to focus on certain patterns or trends.</p>
                        <button id="customPrediction" class="p-2 bg-accent text-white rounded-lg hover:bg-green-700 mt-4 w-full" onclick="openModal()">Customize Prediction</button>
                    </div>
                </div>
                
                <!-- Prediction Results -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-medium">Prediction Results</h3>
                        <button id="exportPrediction" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 text-sm">Export</button>
                    </div>
                    
                    <div id="predictionResults" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-gray-500 dark:text-gray-400">Generate predictions to see results</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <h4 class="font-medium">Predicted Numbers</h4>
                            <div id="predictedNumbers" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                        <div>
                            <h4 class="font-medium">Confidence Scores</h4>
                            <div id="confidenceScores" class="text-sm mt-2"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-medium">Prediction Visualization</h4>
                        <canvas id="predictionVizChart" class="chart-container"></canvas>
                    </div>
                </div>
                
                <!-- AI Explanation -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">How Our AI Works</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Machine Learning Models</h4>
                            <p class="text-xs mt-1">Our prediction engine uses an ensemble of machine learning models including Random Forests, Gradient Boosting, and Neural Networks to analyze historical lottery data and identify complex patterns.</p>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Statistical Analysis</h4>
                            <p class="text-xs mt-1">Advanced statistical methods like Markov Chains, Monte Carlo simulations, and Bayesian inference are applied to calculate probabilities and identify trends beyond simple frequency analysis.</p>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Pattern Recognition</h4>
                            <p class="text-xs mt-1">The AI examines number sequences, gaps between numbers, sum distributions, and other mathematical properties to detect subtle patterns that might indicate higher probability combinations.</p>
                        </div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-medium text-sm">Limitations</h4>
                            <p class="text-xs mt-1">While our AI provides sophisticated analysis, lottery draws are fundamentally random. These predictions should be used for entertainment purposes only, with no guarantee of winning.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Application Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- General Settings -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">General Settings</h3>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="darkModeToggle" class="mr-2" checked>
                                <span>Dark Mode</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="notificationsToggle" class="mr-2" checked>
                                <span>Enable Notifications</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="animationsToggle" class="mr-2" checked>
                                <span>Enable Animations</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mt-2">Default Game</label>
                            <select id="defaultGame" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                                <option value="powerball">Powerball</option>
                                <option value="megamillions">Mega Millions</option>
                                <option value="euromillions">EuroMillions</option>
                                <option value="lotto649">Lotto 6/49</option>
                                <option value="lotto645">Lotto 6/45</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Data Management -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-medium">Data Management</h3>
                        
                        <div>
                            <label class="block text-sm font-medium">Clear All Data</label>
                            <button id="clearAllData" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600 w-full mt-1">Reset Application</button>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Warning: This will delete all saved data and reset to defaults</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mt-2">Export All Data</label>
                            <button id="exportAllData" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 w-full mt-1">Export Data</button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mt-2">Import Data</label>
                            <input type="file" id="importData" class="w-full p-2 border rounded-lg dark:bg-gray-700 mt-1">
                        </div>
                    </div>
                </div>
                
                <!-- About Section -->
                <div class="mt-6">
                    <h3 class="text-xl font-medium mb-2">About Lotto Genius Pro</h3>
                    <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm">Version: 2.1.0</p>
                        <p class="text-sm mt-1">Developed by: Lotto Genius Team</p>
                        <p class="text-sm mt-1">License: MIT</p>
                        <p class="text-sm mt-1">Disclaimer: This application is for entertainment purposes only. There is no guarantee that using this system will result in winning lottery numbers. Please play responsibly.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Custom Prediction Modal -->
        <div id="predictionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
                <h2 class="text-2xl font-semibold mb-4">Custom Prediction Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Prediction Model</label>
                        <select id="predictionModel" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                            <option value="ensemble">Ensemble Model (Recommended)</option>
                            <option value="randomForest">Random Forest</option>
                            <option value="neuralNetwork">Neural Network</option>
                            <option value="markov">Markov Chain</option>
                            <option value="bayesian">Bayesian Network</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium">Historical Data Range</label>
                        <select id="dataRange" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                            <option value="1year">Last Year</option>
                            <option value="3years">Last 3 Years</option>
                            <option value="5years">Last 5 Years</option>
                            <option value="10years">Last 10 Years</option>
                            <option value="all">All Available Data</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium">Focus Parameters</label>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <label class="flex items-center"><input type="checkbox" class="focusParam mr-2" value="frequency" checked> Number Frequency</label>
                            <label class="flex items-center"><input type="checkbox" class="focusParam mr-2" value="gap" checked> Gap Analysis</label>
                            <label class="flex items-center"><input type="checkbox" class="focusParam mr-2" value="patterns"> Number Patterns</label>
                            <label class="flex items-center"><input type="checkbox" class="focusParam mr-2" value="sum"> Sum Analysis</label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium">Number of Predictions</label>
                        <input id="numPredictions" type="number" min="1" max="40" class="w-full p-2 border rounded-lg dark:bg-gray-700" value="5">
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <button id="cancelPrediction" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex-1">Cancel</button>
                        <button id="runPrediction" class="p-2 bg-primary text-white rounded-lg hover:bg-blue-700 flex-1">Run Prediction</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Notification -->
        <div id="successNotification" class="fixed bottom-4 right-4 bg-accent text-white p-4 rounded-lg shadow-lg hidden transition-all duration-300 transform translate-y-4 opacity-0 z-50">
            Operation completed successfully!
        </div>

        <!-- Footer -->
        <footer class="mt-8 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg text-center">
            <div class="mb-4">
                <h3 class="text-xl font-semibold">Lotto Genius Pro</h3>
                <p class="text-sm">Advanced lottery prediction and analysis system powered by AI and statistical algorithms.</p>
            </div>
            <div class="mb-4">
                <h4 class="font-medium">Quick Links</h4>
                <ul class="flex flex-wrap justify-center gap-4">
                    <li><a href="#dashboard" class="text-primary hover:underline">Dashboard</a></li>
                    <li><a href="#generator" class="text-primary hover:underline">Smart Generator</a></li>
                    <li><a href="#analyzer" class="text-primary hover:underline">Advanced Analyzer</a></li>
                    <li><a href="#strategies" class="text-primary hover:underline">AI Strategies</a></li>
                </ul>
            </div>
            <div class="mb-4">
                <h4 class="font-medium">Disclaimer</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">This application is for entertainment purposes only. There is no guarantee that using this system will result in winning lottery numbers. Please play responsibly.</p>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">© 2023 Lotto Genius Pro. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // Gemini API Key (Leave empty for Canvas environment to provide)
        const apiKey = ""; 

        // Game Configurations
const gameConfigs = {
    powerball: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1, optimal: { sumRange: [130, 200], oddEvenRatio: [2,3], consecutiveMax: 1, primeCount: [1,2], fibCount: [0,1], groupDistribution: { '1-10': [0,2], '11-20': [1,3], '21-30': [1,3], '31-40': [0,2], '41-50': [0,2], '51-60': [0,2], '61-69': [0,1] } },
    megamillions: { mainPool: 70, pickCount: 5, bonusPool: 25, bonusCount: 1, optimal: { sumRange: [130, 200], oddEvenRatio: [2,3], consecutiveMax: 1, primeCount: [1,2], fibCount: [0,1], groupDistribution: { '1-10': [0,2], '11-20': [1,3], '21-30': [1,3], '31-40': [0,2], '41-50': [0,2], '51-60': [0,2], '61-70': [0,1] } },
    euromillions: { mainPool: 50, pickCount: 5, bonusPool: 12, bonusCount: 2, optimal: { sumRange: [100, 150], oddEvenRatio: [2,3], consecutiveMax: 1, primeCount: [1,2], fibCount: [0,1], groupDistribution: { '1-10': [1,2], '11-20': [1,2], '21-30': [1,2], '31-40': [0,1], '41-50': [0,1] } },
    lotto649: { mainPool: 49, pickCount: 6, bonusPool: 49, bonusCount: 1, optimal: { sumRange: [100, 180], oddEvenRatio: [3,3], consecutiveMax: 2, primeCount: [1,3], fibCount: [0,2], groupDistribution: { '1-10': [1,2], '11-20': [1,2], '21-30': [1,2], '31-40': [1,2], '41-49': [0,1] } },
    lotto645: { mainPool: 45, pickCount: 6, bonusPool: 45, bonusCount: 1, optimal: { sumRange: [90, 170], oddEvenRatio: [3,3], consecutiveMax: 2, primeCount: [1,3], fibCount: [0,2], groupDistribution: { '1-10': [1,2], '11-20': [1,2], '21-30': [1,2], '31-40': [1,2], '41-45': [0,1] } },
    custom: { mainPool: 69, pickCount: 5, bonusPool: 26, bonusCount: 1, optimal: { sumRange: [130, 200], oddEvenRatio: [2,3], consecutiveMax: 1, primeCount: [1,2], fibCount: [0,1], groupDistribution: { '1-10': [0,2], '11-20': [1,3], '21-30': [1,3], '31-40': [0,2], '41-50': [0,2], '51-60': [0,2], '61-69': [0,1] } } }
};

        // Application State
        const appState = {
            historicalData: [],
            currentPage: 1,
            drawsPerPage: 10,
            savedTickets: [],
            notificationCount: 0,
            darkMode: true,
            animations: true,
            notifications: true,
            defaultGame: 'powerball',
            lastPredictionConfig: null // Store last prediction configuration
        };

        // Chart Instances
        const charts = {};

        // Initialize Application
        function initApp() {
            initCharts();
            initEventListeners();
            loadSettings();
            updateUI();
        }

        // Initialize Charts
        function initCharts() {
            const chartConfigs = [
                { id: 'dashboardHeatmap', type: 'bar', label: 'Number Frequency Heatmap' },
                { id: 'dashboardPatterns', type: 'line', label: 'Recent Patterns' },
                { id: 'numberFrequencyChart', type: 'bar', label: 'Number Frequency' },
                { id: 'sumAnalysisChart', type: 'bar', label: 'Sum Distribution' },
                { id: 'patternAnalysisChart', type: 'bar', label: 'Consecutive Pairs' },
                { id: 'freqDistributionChart', type: 'bar', label: 'Frequency Distribution' },
                { id: 'lastDigitDistributionChart', type: 'bar', label: 'Last Digit Distribution' },
                { id: 'sumDistributionChart', type: 'bar', label: 'Sum Distribution' },
                { id: 'oddEvenDistributionChart', type: 'pie', label: 'Odd/Even Distribution' },
                { id: 'freqHeatmapChart', type: 'bar', label: 'Frequency Heatmap' },
                { id: 'freqOverTimeChart', type: 'line', label: 'Frequency Over Time' },
                { id: 'gapAnalysisChart', type: 'bar', label: 'Gap Analysis' },
                { id: 'probDistributionChart', type: 'bar', label: 'Probability Distribution' },
                { id: 'predictionVizChart', type: 'bar', label: 'Prediction Confidence' },
                { id: 'reverseChart', type: 'bar', label: 'Reverse Engineered Numbers' }, // New chart for reverse engineer
                { id: 'seedVisualsChart', type: 'bar', label: 'Seed Number Distribution' } // New chart for seed reverser
            ];

            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id)?.getContext('2d');
                if (ctx) {
                    charts[config.id] = new Chart(ctx, {
                        type: config.type,
                        data: {
                            labels: [],
                            datasets: [{
                                label: config.label,
                                data: [],
                                backgroundColor: config.type === 'pie' ? 
                                    ['#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444'] : 
                                    '#3B82F6',
                                borderColor: '#3B82F6',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: config.type !== 'pie' ? {
                                y: { beginAtZero: true }
                            } : {}
                        }
                    });
                }
            });
        }

        // Initialize Event Listeners
        function initEventListeners() {
            // Theme and UI Controls
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('notifications').addEventListener('click', showNotifications);
            
            // Game Configuration
            document.getElementById('lotteryGame').addEventListener('change', handleGameChange);
            document.getElementById('probabilityGame').addEventListener('change', handleProbabilityGameChange);
            document.getElementById('analyzerGame').addEventListener('change', handleAnalyzerGameChange); // New event listener for analyzer game
            document.getElementById('historicalGame').addEventListener('change', handleHistoricalGameChange); // New event listener for historical game
            document.getElementById('randomSeedBtn').addEventListener('click', generateRandomSeed);
            document.getElementById('reverseGame').addEventListener('change', () => { /* No specific action needed for game change yet */ });
            
            // Generator Controls
            document.getElementById('generateSmart').addEventListener('click', generateSmartNumbers);
            document.getElementById('quickPick').addEventListener('click', quickPick);
            document.getElementById('generateWheeling').addEventListener('click', generateWheelingSystem);
            document.getElementById('clearGenerator').addEventListener('click', clearGenerator);
            
            // Export Controls
            document.getElementById('exportTxt').addEventListener('click', exportTicketsTxt);
            document.getElementById('exportCsv').addEventListener('click', exportTicketsCsv);
            document.getElementById('copyTickets').addEventListener('click', copyTickets);
            document.getElementById('saveTickets').addEventListener('click', saveTickets);
            
            // Analyzer Controls
            document.getElementById('analyzeNumbers').addEventListener('click', analyzeNumbers);
            document.getElementById('clearAnalyzer').addEventListener('click', clearAnalyzer);
            document.getElementById('getAIInsights').addEventListener('click', getAIInsights);
            document.getElementById('predictAdvanced').addEventListener('click', generateAdvancedPrediction);
            document.getElementById('regenerateAdvancedPrediction').addEventListener('click', regenerateAdvancedPrediction);
            document.getElementById('clearAdvancedPrediction').addEventListener('click', clearAdvancedPrediction);
            document.querySelectorAll('.sample-input').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.getElementById('numbersToAnalyze').value = e.target.dataset.sample;
                });
            });

            // Combinatorics Lab Controls
            document.getElementById('findCommonPairs').addEventListener('click', findCommonPairs);
            document.getElementById('useHistoricalForPairs').addEventListener('click', useHistoricalDataForPairs);
            document.getElementById('clearPairs').addEventListener('click', clearPairsGenerator);
            document.getElementById('generateCombinations').addEventListener('click', generateCombinations);
            document.getElementById('clearCombinations').addEventListener('click', clearCombinationsGenerator);
            document.getElementById('exportCombinationsTxt').addEventListener('click', exportCombinationsTxt);
            document.getElementById('copyCombinations').addEventListener('click', copyAllCombinations);

            // Reverse Engineer Controls
            document.getElementById('reverseEngineerBtn').addEventListener('click', reverseEngineerNumbers);
            document.getElementById('clearReverse').addEventListener('click', clearReverseEngineer);
            
            // Historical Data Controls
            document.getElementById('dataSource').addEventListener('change', handleDataSourceChange);
            document.getElementById('loadData').addEventListener('click', loadHistoricalData);
            document.getElementById('clearHistorical').addEventListener('click', clearHistoricalData);
            document.getElementById('prevPage').addEventListener('click', prevPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
            document.getElementById('exportHistorical').addEventListener('click', exportHistoricalData);
            
            // Strategy Controls
            document.querySelectorAll('.applyStrategy').forEach(btn => {
                btn.addEventListener('click', applyStrategy);
            });
            document.getElementById('buildStrategy').addEventListener('click', buildCustomStrategy);
            document.querySelectorAll('.strategyComponent').forEach(comp => {
                comp.addEventListener('change', updateStrategyWeights);
            });
            document.querySelectorAll('#freqWeight, #gapWeight, #patternWeight, #otherWeight').forEach(slider => {
                slider.addEventListener('input', updateStrategyWeightValues);
            });
            
            // Probability Controls
            document.getElementById('calculateProb').addEventListener('click', calculateProbabilities);
            document.getElementById('resetProb').addEventListener('click', resetProbabilityCalculator);
            document.getElementById('exportProb').addEventListener('click', exportProbabilityResults);
            
            // Prediction Controls
            document.getElementById('generatePrediction').addEventListener('click', generatePrediction);
            document.getElementById('forecastDraws').addEventListener('click', forecastDraws);
            document.getElementById('customPrediction').addEventListener('click', openModal);
            document.getElementById('cancelPrediction').addEventListener('click', closeModal);
            document.getElementById('runPrediction').addEventListener('click', runCustomPrediction);
            document.getElementById('exportPrediction').addEventListener('click', exportPredictionResults);
            
            // Settings Controls
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkModeSetting);
            document.getElementById('notificationsToggle').addEventListener('change', toggleNotificationsSetting);
            document.getElementById('animationsToggle').addEventListener('change', toggleAnimationsSetting);
            document.getElementById('defaultGame').addEventListener('change', updateDefaultGame);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            document.getElementById('exportAllData').addEventListener('click', exportAllData);
            document.getElementById('importData').addEventListener('change', importData);
            
            // Quick Actions
            document.querySelectorAll('.quick-action').forEach(btn => {
                btn.addEventListener('click', handleQuickAction);
            });
        }

        // UI Functions
        function toggleTheme() {
            document.body.classList.toggle('dark');
            appState.darkMode = document.body.classList.contains('dark');
            saveSettings();
            showNotification('Theme toggled successfully!');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-hidden');
            const mainContent = document.querySelector('.main-content-area');
            if (sidebar.classList.contains('sidebar-hidden')) {
                mainContent.classList.remove('md:ml-64');
                mainContent.classList.add('ml-0');
            } else {
                mainContent.classList.remove('ml-0');
                mainContent.classList.add('md:ml-64');
            }
        }

        function showNotifications() {
            showNotification('You have ' + appState.notificationCount + ' notifications');
        }

        function showNotification(message) {
            if (!appState.notifications) return;
            
            const notification = document.getElementById('successNotification');
            notification.textContent = message;
            notification.classList.remove('hidden', 'translate-y-4', 'opacity-0');
            notification.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
            
            appState.notificationCount++;
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (appState.notificationCount > 0) {
                badge.textContent = appState.notificationCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openModal() {
            document.getElementById('predictionModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('predictionModal').classList.add('hidden');
        }

        function updateUI() {
            if (appState.darkMode) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            document.getElementById('darkModeToggle').checked = appState.darkMode;
            document.getElementById('notificationsToggle').checked = appState.notifications;
            document.getElementById('animationsToggle').checked = appState.animations;
            document.getElementById('defaultGame').value = appState.defaultGame;
            
            updateNotificationBadge();

            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content-area');
            if (window.innerWidth < 768) {
                sidebar.classList.add('sidebar-hidden');
                mainContent.classList.remove('md:ml-64');
                mainContent.classList.add('ml-0');
            } else {
                sidebar.classList.remove('sidebar-hidden');
                mainContent.classList.add('md:ml-64');
                mainContent.classList.remove('ml-0');
            }
        }

        // Game Configuration Functions
        function handleGameChange(e) {
            const game = e.target.value;
            const customConfig = document.getElementById('customGameConfig');
            
            if (game === 'custom') {
                customConfig.classList.remove('hidden');
            } else {
                customConfig.classList.add('hidden');
                const config = gameConfigs[game];
                document.getElementById('mainPool').value = config.mainPool;
                document.getElementById('pickCount').value = config.pickCount;
                document.getElementById('bonusPool').value = config.bonusPool;
                document.getElementById('bonusCount').value = config.bonusCount;
            }
        }

        function handleProbabilityGameChange(e) {
            const game = e.target.value;
            const customConfig = document.getElementById('customProbabilityConfig');
            
            if (game === 'custom') {
                customConfig.classList.remove('hidden');
            } else {
                customConfig.classList.add('hidden');
                const config = gameConfigs[game];
                document.getElementById('probMainPool').value = config.mainPool;
                document.getElementById('probPickCount').value = config.pickCount;
                document.getElementById('probBonusPool').value = config.bonusPool;
                document.getElementById('probBonusCount').value = config.bonusCount;
            }
        }

        function handleAnalyzerGameChange(e) {
            const game = e.target.value;
            const customConfig = document.getElementById('customAnalyzerGameConfig');
            
            if (game === 'custom') {
                customConfig.classList.remove('hidden');
                const currentConfig = gameConfigs[document.getElementById('analyzerGame').value];
                document.getElementById('analyzerMainPool').value = currentConfig.mainPool;
                document.getElementById('analyzerPickCount').value = currentConfig.pickCount;
                document.getElementById('analyzerBonusPool').value = currentConfig.bonusPool;
                document.getElementById('analyzerBonusCount').value = currentConfig.bonusCount;
            } else {
                customConfig.classList.add('hidden');
            }
        }

        function handleHistoricalGameChange(e) {
            const game = e.target.value;
            const customConfig = document.getElementById('customHistoricalGameConfig');
            
            if (game === 'custom') {
                customConfig.classList.remove('hidden');
                // Populate custom fields with current game's default values if available
                const currentConfig = gameConfigs[document.getElementById('historicalGame').value];
                document.getElementById('historicalMainPool').value = currentConfig.mainPool;
                document.getElementById('historicalPickCount').value = currentConfig.pickCount;
                document.getElementById('historicalBonusPool').value = currentConfig.bonusPool;
                document.getElementById('historicalBonusCount').value = currentConfig.bonusCount;
            } else {
                customConfig.classList.add('hidden');
            }
        }

        function handleDataSourceChange(e) {
            const source = e.target.value;
            const csvUploadContainer = document.getElementById('csvUploadContainer');
            const manualInputContainer = document.getElementById('manualInputContainer'); // Get the new manual input container
            
            // Hide all input containers first
            csvUploadContainer.classList.add('hidden');
            manualInputContainer.classList.add('hidden');
            
            // Show the relevant container based on the selected source
            if (source === 'csv') {
                csvUploadContainer.classList.remove('hidden');
            } else if (source === 'manual') { // Handle manual input
                manualInputContainer.classList.remove('hidden');
            }
        }

        function generateRandomSeed() {
            document.getElementById('randomSeed').value = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Number Generation Functions
        async function generateNumbers(config, method, options = {}) {
            const { mainPool, pickCount, bonusPool, bonusCount } = config;
            let numbers = [];

            switch (method) {
                case 'standard':
                case 'quick':
                    numbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
                    break;
                    
                case 'fisherYates':
                    const array = Array.from({ length: mainPool }, (_, i) => i + 1);
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    numbers = array.slice(0, pickCount);
                    break;
                    
                case 'crypto':
                    if (window.crypto) {
                        const array = new Uint32Array(pickCount);
                        window.crypto.getRandomValues(array);
                        numbers = Array.from(array).map(n => (n % mainPool) + 1);
                    } else {
                        numbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
                    }
                    break;
                    
                case 'lowHigh':
                    const lowCount = Math.floor(pickCount / 2);
                    const highCount = pickCount - lowCount;
                    const low = Array.from({ length: lowCount }, () => Math.floor(Math.random() * (mainPool / 2)) + 1);
                    const high = Array.from({ length: highCount }, () => Math.floor(Math.random() * (mainPool / 2)) + Math.ceil(mainPool / 2));
                    numbers = [...low, ...high];
                    break;
                    
                case 'oddEven':
                    const oddCount = Math.floor(pickCount / 2);
                    const evenCount = pickCount - oddCount;
                    const odd = Array.from({ length: oddCount }, () => {
                        let num;
                        do {
                            num = Math.floor(Math.random() * mainPool) + 1;
                        } while (num % 2 === 0);
                        return num;
                    });
                    const even = Array.from({ length: evenCount }, () => {
                        let num;
                        do {
                            num = Math.floor(Math.random() * mainPool) + 1;
                        } while (num % 2 === 1);
                        return num;
                    });
                    numbers = [...odd, ...even];
                    break;
                    
                case 'prime':
                    const primes = getPrimesUpTo(mainPool);
                    numbers = Array.from({ length: pickCount }, () => {
                        return primes[Math.floor(Math.random() * primes.length)];
                    });
                    break;
                    
                case 'fibonacci':
                    const fibs = getFibonacciUpTo(mainPool);
                    numbers = Array.from({ length: pickCount }, () => {
                        return fibs[Math.floor(Math.random() * fibs.length)];
                    });
                    break;
                    
                case 'statistical':
                case 'ai':
                    numbers = await generateUsingAI(config, options);
                    break;

                case 'quantumInspired':
                    numbers = await generateUsingQuantumInspiredAI(config, options);
                    break;
                    
                default:
                    numbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
            }

            numbers = [...new Set(numbers)].sort((a, b) => a - b);
            
            while (numbers.length < pickCount) {
                const randomNum = Math.floor(Math.random() * mainPool) + 1;
                if (!numbers.includes(randomNum)) {
                    numbers.push(randomNum);
                }
                numbers.sort((a, b) => a - b);
            }

            if (options.sumFilter && options.sumFilter !== 'any') {
                const sum = numbers.reduce((a, b) => a + b, 0);
                const avg = mainPool / 2 * pickCount;
                
                let isValid = true;
                switch (options.sumFilter) {
                    case 'low': isValid = sum < avg * 0.8; break;
                    case 'medium': isValid = sum >= avg * 0.8 && sum <= avg * 1.2; break;
                    case 'high': isValid = sum > avg * 1.2; break;
                }
                
                if (!isValid) return generateNumbers(config, method, options);
            }
            
            if (options.consecutiveFilter && options.consecutiveFilter !== 'any') {
                const consecutivePairs = countConsecutivePairs(numbers);
                let isValid = true;
                
                switch (options.consecutiveFilter) {
                    case 'none': isValid = consecutivePairs === 0; break;
                    case 'max1': isValid = consecutivePairs <= 1; break;
                    case 'max2': isValid = consecutivePairs <= 2; break;
                }
                
                if (!isValid) return generateNumbers(config, method, options);
            }

            const bonus = Array.from({ length: bonusCount }, () => Math.floor(Math.random() * bonusPool) + 1);
            
            return { numbers, bonus };
        }

        async function generateUsingAI(config, options) {
            const { mainPool, pickCount } = config;
            let generatedNumbers = [];

            const generateSmartBtn = document.getElementById('generateSmart');
            let loadingIndicator = generateSmartBtn.querySelector('.loading-indicator');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('span');
                loadingIndicator.className = 'loading-indicator';
                generateSmartBtn.appendChild(loadingIndicator);
            }
            loadingIndicator.classList.remove('hidden');

            try {
                let prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.`;
                if (options.useHistorical && appState.historicalData.length > 0) {
                    const frequency = getNumberFrequency();
                    const gaps = getGapAnalysis();
                    prompt += ` Consider the following historical data: Most frequent numbers: ${JSON.stringify(frequency)}. Numbers with longest gaps since last appearance: ${JSON.stringify(gaps)}.`;
                    if (options.favorHot) prompt += ` Favor hot numbers.`;
                    if (options.includeDue) prompt += ` Include numbers that are statistically due.`;
                    if (options.avoidRepeats) prompt += ` Avoid numbers that have appeared in the last 5 draws.`;
                }
                prompt += ` Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40". Do not include any other text or explanation.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    const parsed = text.split(',').map(Number).filter(n => !isNaN(n) && n >= 1 && n <= mainPool);
                    
                    generatedNumbers = [...new Set(parsed)].slice(0, pickCount);

                    while (generatedNumbers.length < pickCount) {
                        const randomNum = Math.floor(Math.random() * mainPool) + 1;
                        if (!generatedNumbers.includes(randomNum)) {
                            generatedNumbers.push(randomNum);
                        }
                    }
                } else {
                    console.error("Gemini API did not return expected content structure.");
                    showNotification("AI generation failed. Falling back to random numbers.");
                    generatedNumbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
                }
            } catch (error) {
                console.error("Error calling Gemini API for AI generation:", error);
                showNotification("AI generation failed due to an error. Falling back to random numbers.");
                generatedNumbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
            
            return generatedNumbers;
        }

        async function generateUsingQuantumInspiredAI(config, options) {
            const { mainPool, pickCount } = config;
            let generatedNumbers = [];

            const generateSmartBtn = document.getElementById('generateSmart');
            let loadingIndicator = generateSmartBtn.querySelector('.loading-indicator');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('span');
                loadingIndicator.className = 'loading-indicator';
                generateSmartBtn.appendChild(loadingIndicator);
            }
            loadingIndicator.classList.remove('hidden');

            try {
                if (appState.historicalData.length === 0) {
                    showNotification("No historical data for Quantum-Inspired algorithm. Please load data first.");
                    return Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
                }

                const numberScores = {};
                for (let i = 1; i <= mainPool; i++) {
                    numberScores[i] = 0;
                }

                // Step 1: Calculate "Quantum State" (Probability Scores)
                // Combine frequency and gap analysis
                const frequency = getNumberFrequency();
                const gaps = getGapAnalysis();
                const pairFrequency = getPairFrequency();

                const maxFreq = Math.max(...Object.values(frequency), 1);
                const maxGap = Math.max(...Object.values(gaps), 1);
                const maxPairFreq = Math.max(...Object.values(pairFrequency), 1);

                for (let i = 1; i <= mainPool; i++) {
                    let score = 0;

                    // Frequency contribution
                    score += (frequency[i] || 0) / maxFreq * 0.4; // 40% importance

                    // Gap contribution (higher gap means more "due")
                    score += (gaps[i] || 0) / maxGap * 0.3; // 30% importance

                    // Pair correlation contribution (entanglement-like)
                    let pairScore = 0;
                    for (const pair in pairFrequency) {
                        const [num1, num2] = pair.split('-').map(Number);
                        if (num1 === i || num2 === i) {
                            pairScore += pairFrequency[pair];
                        }
                    }
                    score += (pairScore / maxPairFreq) * 0.2; // 20% importance

                    // Step 2: Introduce "Quantum Fluctuations" (controlled randomness)
                    score += Math.random() * 0.1; // 10% randomness for exploration

                    numberScores[i] = score;
                }

                // Step 3 & 4: "Measure" (Select Numbers)
                const sortedNumbers = Object.entries(numberScores)
                    .sort(([, scoreA], [, scoreB]) => scoreB - scoreA)
                    .map(([num]) => parseInt(num));

                generatedNumbers = [];
                let attempts = 0;
                const maxAttempts = 100; // Prevent infinite loops

                while (generatedNumbers.length < pickCount && attempts < maxAttempts) {
                    // Select from the top-scoring numbers, but also allow some lower-scoring ones
                    // This simulates a probabilistic "collapse" of the quantum state
                    const selectionPool = sortedNumbers.slice(0, Math.min(mainPool, pickCount * 3)); // Consider top N*3 numbers
                    
                    let selectedNum;
                    if (selectionPool.length > 0) {
                        // Weighted random selection from the pool
                        const totalScore = selectionPool.reduce((sum, num) => sum + numberScores[num], 0);
                        let randomPoint = Math.random() * totalScore;

                        for (const num of selectionPool) {
                            randomPoint -= numberScores[num];
                            if (randomPoint <= 0) {
                                selectedNum = num;
                                break;
                            }
                        }
                    } else {
                        // Fallback to pure random if selection pool is empty
                        selectedNum = Math.floor(Math.random() * mainPool) + 1;
                    }

                    if (selectedNum && !generatedNumbers.includes(selectedNum)) {
                        generatedNumbers.push(selectedNum);
                    }
                    attempts++;
                }

                // Ensure pickCount is met, fill with random if necessary (shouldn't happen often with good scoring)
                while (generatedNumbers.length < pickCount) {
                    const randomNum = Math.floor(Math.random() * mainPool) + 1;
                    if (!generatedNumbers.includes(randomNum)) {
                        generatedNumbers.push(randomNum);
                    }
                }

                generatedNumbers = generatedNumbers.slice(0, pickCount); // Trim if somehow over
            } catch (error) {
                console.error("Error in Quantum-Inspired generation:", error);
                showNotification("Quantum-Inspired generation failed. Falling back to random numbers.");
                generatedNumbers = Array.from({ length: pickCount }, () => Math.floor(Math.random() * mainPool) + 1);
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }

            return generatedNumbers;
        }


        function getPrimesUpTo(max) {
            const primes = [];
            for (let i = 2; i <= max; i++) {
                let isPrime = true;
                for (let j = 2, sqrt = Math.sqrt(i); j <= sqrt; j++) {
                    if (i % j === 0) { isPrime = false; break; }
                }
                if (isPrime) primes.push(i);
            }
            return primes;
        }

        function getFibonacciUpTo(max) {
            const fibs = [1, 1];
            while (fibs[fibs.length - 1] <= max) {
                fibs.push(fibs[fibs.length - 1] + fibs[fibs.length - 2]);
            }
            return fibs.filter(n => n <= max);
        }

        function countConsecutivePairs(numbers) {
            let pairs = 0;
            const sorted = [...numbers].sort((a, b) => a - b);
            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] - sorted[i - 1] === 1) pairs++;
            }
            return pairs;
        }

        function generateWheelingSystem(config, numTickets) {
            const { mainPool, pickCount, bonusCount, bonusPool } = config;
            const wheel = [];
            const baseNumbers = Array.from({ length: pickCount + 2 }, () => Math.floor(Math.random() * mainPool) + 1);
            
            for (let i = 0; i < numTickets; i++) {
                const ticket = [...new Set(baseNumbers.map(n => (n + i) % mainPool + 1))].slice(0, pickCount).sort((a, b) => a - b);
                const bonus = Array.from({ length: bonusCount }, () => Math.floor(Math.random() * bonusPool) + 1);
                wheel.push({ numbers: ticket, bonus });
            }
            
            return wheel;
        }

        // Generator Functions
        async function generateSmartNumbers() {
            const game = document.getElementById('lotteryGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('mainPool').value) || 69,
                pickCount: parseInt(document.getElementById('pickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('bonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('bonusCount').value) || 1
            } : gameConfigs[game];
            
            const method = document.getElementById('generationMethod').value;
            const options = {
                useHistorical: document.getElementById('useHistorical').checked,
                favorHot: document.getElementById('favorHot').checked,
                includeDue: document.getElementById('includeDue').checked,
                avoidRepeats: document.getElementById('avoidRepeats').checked,
                sumFilter: document.getElementById('sumFilter').value,
                consecutiveFilter: document.getElementById('consecutiveFilter').value
            };
            
            const numTickets = parseInt(document.getElementById('numTickets').value) || 1;
            const tickets = [];
            
            const generateSmartBtn = document.getElementById('generateSmart');
            let loadingIndicator = generateSmartBtn.querySelector('.loading-indicator');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('span');
                loadingIndicator.className = 'loading-indicator';
                generateSmartBtn.appendChild(loadingIndicator);
            }
            loadingIndicator.classList.remove('hidden');

            for (let i = 0; i < numTickets; i++) {
                const ticket = await generateNumbers(config, method, options);
                tickets.push(ticket);
            }

            loadingIndicator.classList.add('hidden');

            displayTickets(tickets);
            updateGeneratorCharts(tickets);
            updateStatsOverview(tickets);
            showNotification('Smart numbers generated successfully!');
        }

        async function quickPick() {
            const game = document.getElementById('lotteryGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('mainPool').value) || 69,
                pickCount: parseInt(document.getElementById('pickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('bonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('bonusCount').value) || 1
            } : gameConfigs[game];
            
            const tickets = [await generateNumbers(config, 'quick', {})];
            displayTickets(tickets);
            updateGeneratorCharts(tickets);
            updateStatsOverview(tickets);
            showNotification('Quick pick generated successfully!');
        }

        async function generateWheelingSystem() {
            const game = document.getElementById('lotteryGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('mainPool').value) || 69,
                pickCount: parseInt(document.getElementById('pickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('bonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('bonusCount').value) || 1
            } : gameConfigs[game];
            
            const numTickets = parseInt(document.getElementById('numTickets').value) || 1;
            const tickets = generateWheelingSystem(config, numTickets);
            
            displayTickets(tickets);
            updateGeneratorCharts(tickets);
            updateStatsOverview(tickets);
            showNotification('Wheeling system generated successfully!');
        }

        function displayTickets(tickets) {
            const ticketsDiv = document.getElementById('generatedTickets');
            
            if (tickets.length === 0) {
                ticketsDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>';
                return;
            }
            
            ticketsDiv.innerHTML = tickets.map((ticket, index) => `
                <div class="p-3 bg-white dark:bg-gray-600 rounded-lg mb-2 border border-gray-200 dark:border-gray-500">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium">Ticket ${index + 1}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Sum: ${ticket.numbers.reduce((a, b) => a + b, 0)}</span>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-1">
                        ${ticket.numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${ticket.bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updateGeneratorCharts(tickets) {
            if (tickets.length === 0) {
                ['numberFrequencyChart', 'sumAnalysisChart', 'patternAnalysisChart'].forEach(id => {
                    if (charts[id]) {
                        charts[id].data.labels = [];
                        charts[id].data.datasets[0].data = [];
                        charts[id].update();
                    }
                });
                return;
            }
            
            const numbers = tickets.flatMap(t => t.numbers);
            const frequencyMap = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});
            
            const frequencyLabels = Object.keys(frequencyMap).sort((a, b) => a - b);
            const frequencyData = frequencyLabels.map(label => frequencyMap[label]);
            
            if (charts.numberFrequencyChart) {
                charts.numberFrequencyChart.data.labels = frequencyLabels;
                charts.numberFrequencyChart.data.datasets[0].data = frequencyData;
                charts.numberFrequencyChart.update();
            }
            
            const sums = tickets.map(t => t.numbers.reduce((a, b) => a + b, 0));
            const sumLabels = tickets.map((_, i) => `Ticket ${i + 1}`);
            
            if (charts.sumAnalysisChart) {
                charts.sumAnalysisChart.data.labels = sumLabels;
                charts.sumAnalysisChart.data.datasets[0].data = sums;
                charts.sumAnalysisChart.update();
            }
            
            const patterns = tickets.map(t => countConsecutivePairs(t.numbers));
            
            if (charts.patternAnalysisChart) {
                charts.patternAnalysisChart.data.labels = sumLabels;
                charts.patternAnalysisChart.data.datasets[0].data = patterns;
                charts.patternAnalysisChart.update();
            }
        }

        function clearGenerator() {
            document.getElementById('generatedTickets').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate some numbers to see results</p>';
            
            ['numberFrequencyChart', 'sumAnalysisChart', 'patternAnalysisChart'].forEach(id => {
                 if (charts[id]) {
                    charts[id].data.labels = [];
                    charts[id].data.datasets[0].data = [];
                    charts[id].update();
                }
            });
            
            showNotification('Generator cleared!');
        }

        // Export Functions
        function exportTicketsTxt() {
            const ticketsDiv = document.getElementById('generatedTickets');
            if (ticketsDiv.textContent.includes('Generate some numbers')) {
                showNotification('No tickets to export!');
                return;
            }
            
            const ticketsText = Array.from(ticketsDiv.querySelectorAll('.p-3')).map(div => {
                const numbers = Array.from(div.querySelectorAll('.number-ball:not(.bonus-ball)')).map(ball => ball.textContent);
                const bonus = Array.from(div.querySelectorAll('.bonus-ball')).map(ball => ball.textContent);
                return `Numbers: ${numbers.join(', ')} | Bonus: ${bonus.join(', ')}`;
            }).join('\n');
            
            const blob = new Blob([ticketsText], { type: 'text/plain' });
            downloadBlob(blob, 'tickets.txt');
            showNotification('Tickets exported as TXT!');
        }

        function exportTicketsCsv() {
    const ticketsDiv = document.getElementById('generatedTickets');
    if (ticketsDiv.textContent.includes('Generate some numbers')) {
        showNotification('No tickets to export!');
        return;
    }
    
    let csvContent = 'Ticket,Numbers,Bonus\n';
    Array.from(ticketsDiv.querySelectorAll('.p-3')).forEach((div, index) => {
        const numbers = Array.from(div.querySelectorAll('.number-ball:not(.bonus-ball)')).map(ball => ball.textContent);
        const bonus = Array.from(div.querySelectorAll('.bonus-ball')).map(ball => ball.textContent);
        csvContent += `Ticket ${index + 1},"${numbers.join(',')}","${bonus.join(',')}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, 'tickets.csv');
    showNotification('Tickets exported as CSV!');
}

        function copyTickets() {
            const ticketsDiv = document.getElementById('generatedTickets');
            if (ticketsDiv.textContent.includes('Generate some numbers')) {
                showNotification('No tickets to copy!');
                return;
            }
            
            const ticketsText = Array.from(ticketsDiv.querySelectorAll('.p-3')).map(div => {
                const numbers = Array.from(div.querySelectorAll('.number-ball:not(.bonus-ball)')).map(ball => ball.textContent);
                const bonus = Array.from(div.querySelectorAll('.bonus-ball')).map(ball => ball.textContent);
                return `Numbers: ${numbers.join(', ')} | Bonus: ${bonus.join(', ')}`;
            }).join('\n');
            
            const textarea = document.createElement('textarea');
            textarea.value = ticketsText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showNotification('Tickets copied to clipboard!');
        }

        function saveTickets() {
            const ticketsDiv = document.getElementById('generatedTickets');
            if (ticketsDiv.textContent.includes('Generate some numbers')) {
                showNotification('No tickets to save!');
                return;
            }
            
            const tickets = Array.from(ticketsDiv.querySelectorAll('.p-3')).map(div => {
                const numbers = Array.from(div.querySelectorAll('.number-ball:not(.bonus-ball)')).map(ball => parseInt(ball.textContent));
                const bonus = Array.from(div.querySelectorAll('.bonus-ball')).map(ball => parseInt(ball.textContent));
                return { numbers, bonus };
            });
            
            appState.savedTickets = [...appState.savedTickets, ...tickets];
            updateRecentActivity(`Saved ${tickets.length} ticket${tickets.length > 1 ? 's' : ''}`);
            showNotification(`${tickets.length} ticket${tickets.length > 1 ? 's' : ''} saved!`);
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Analyzer Functions
        function analyzeNumbers() {
            const input = document.getElementById('numbersToAnalyze').value;
            const numbers = parseNumbers(input);
            
            if (numbers.length === 0) {
                showNotification('Please enter valid numbers!');
                return;
            }
            
            const game = document.getElementById('analyzerGame').value;
            let config;

            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('analyzerMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('analyzerPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('analyzerBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('analyzerBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            const analysis = getNumberAnalysis(numbers, config.mainPool);

            document.getElementById('basicStats').innerHTML = `
                <p>Count: ${analysis.count}</p>
                <p>Sum: ${analysis.sum}</p>
                <p>Average: ${analysis.avg.toFixed(2)}</p>
                <p>Range: ${analysis.min} - ${analysis.max}</p>
            `;
            
            document.getElementById('numberProps').innerHTML = `
                <p>Odd: ${analysis.oddCount} (${analysis.oddPercent.toFixed(1)}%)</p>
                <p>Even: ${analysis.evenCount} (${analysis.evenPercent.toFixed(1)}%)</p>
                <p>Primes: ${analysis.primes}</p>
                <p>Fibonacci: ${analysis.fibs}</p>
            `;
            
            document.getElementById('patternStats').innerHTML = `
                <p>Consecutive Pairs: ${analysis.consecutivePairs}</p>
                <p>Gaps: ${analysis.gaps.join(', ')}</p>
                <p>Last Digits: ${analysis.lastDigits.join(', ')}</p>
            `;
            
            document.getElementById('advancedMetrics').innerHTML = `
                <p>Standard Deviation: ${analysis.stdDev.toFixed(2)}</p>
                <p>Number Spread: ${analysis.spread.toFixed(2)}%</p>
                <p>Low/High Ratio: ${analysis.lowHighRatio.toFixed(2)}</p>
            `;
            
            const inputFrequency = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});

            const sortedByFrequency = Object.entries(inputFrequency).sort((a, b) => b[1] - a[1]);

            const mostUsedNumbers = sortedByFrequency.slice(0, 12).map(([num, count]) => `<span class="number-ball hot-number">${num} (${count}x)</span>`).join('');
            document.getElementById('mostUsedNumbersInput').innerHTML = mostUsedNumbers || '<p>No frequency data.</p>';

            const leastUsedNumbers = sortedByFrequency.slice(-15).reverse().map(([num, count]) => `<span class="number-ball cold-number">${num} (${count}x)</span>`).join('');
            document.getElementById('leastUsedNumbersInput').innerHTML = leastUsedNumbers || '<p>No frequency data.</p>';
            
            const { unusedNumbers, unusedPairs } = detectUnusedFromInput(numbers, config.mainPool);
            const unusedNumbersDiv = document.getElementById('unusedNumbersAndPairs');
            
            const unusedNumbersDisplay = unusedNumbers.length > 0 
                ? unusedNumbers.slice(0, 20).map(n => `<span class="number-ball unused-number">${n}</span>`).join('') + (unusedNumbers.length > 20 ? '...' : '') 
                : 'None';
            const unusedPairsDisplay = unusedPairs.length > 0 
                ? `Analysis complete. Found ${unusedPairs.length.toLocaleString()} unused pairs.` 
                : 'None';

            unusedNumbersDiv.innerHTML = `
                <p><strong>Unused Numbers (${unusedNumbers.length}):</strong> ${unusedNumbersDisplay}</p>
                <p><strong>Unused Pairs (${unusedPairs.length.toLocaleString()}):</strong> ${unusedPairsDisplay}</p>
            `;

            updateAnalyzerCharts(numbers);
            
            document.getElementById('analysisResults').innerHTML = `
                <p class="font-medium">Analysis Complete</p>
                <p class="text-sm">Analyzed ${numbers.length} numbers with average ${analysis.avg.toFixed(2)}</p>
            `;
            
            showNotification('Analysis completed!');
        }

        async function generateAdvancedPrediction() {
            const input = document.getElementById('numbersToAnalyze').value;
            const numbers = parseNumbers(input);

            if (numbers.length === 0) {
                showNotification('Please enter numbers to analyze first to generate predictions!');
                return;
            }

            const game = document.getElementById('analyzerGame').value;
            let config;

            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('analyzerMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('analyzerPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('analyzerBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('analyzerBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }

            const advanceFilter = document.getElementById('advanceFilter').value;
            const predictionAlgorithm = document.getElementById('advancedPredictionAlgorithm').value;
            const numPredictions = 40;

            appState.lastPredictionConfig = {
                inputNumbers: numbers,
                gameConfig: config,
                advanceFilter: advanceFilter,
                predictionAlgorithm: predictionAlgorithm,
                numPredictions: numPredictions
            };

            const advancedPredictionLoading = document.getElementById('advancedPredictionLoading');
            advancedPredictionLoading.classList.remove('hidden');
            document.getElementById('advancedPredictionOutput').classList.remove('hidden');

            const tickets = [];

            const inputFrequencyMap = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});

            const sortedByFrequency = Object.entries(inputFrequencyMap).sort((a, b) => b[1] - a[1]);
            const mostUsed = sortedByFrequency.map(item => parseInt(item[0]));
            const leastUsed = sortedByFrequency.slice().reverse().map(item => parseInt(item[0]));
            const { unusedNumbers } = detectUnusedFromInput(numbers, config.mainPool);

            try {
                for (let i = 0; i < numPredictions; i++) {
                    let mainNumbers = [];
                    let bonusNumbers = Array.from({ length: config.bonusCount }, () => Math.floor(Math.random() * config.bonusPool) + 1);

                    switch (advanceFilter) {
                        case 'balanced':
                            mainNumbers = await generateAICombinedPrediction(mostUsed, leastUsed, unusedNumbers, config.pickCount, config.mainPool, predictionAlgorithm);
                            break;
                        case 'favorUnused':
                            mainNumbers = await generateAIFavorUnused(unusedNumbers, mostUsed, leastUsed, config.pickCount, config.mainPool, predictionAlgorithm);
                            break;
                        case 'favorMostUsed':
                            mainNumbers = await generateAIFavorMostUsed(mostUsed, unusedNumbers, leastUsed, config.pickCount, config.mainPool, predictionAlgorithm);
                            break;
                        case 'favorLeastUsed':
                            mainNumbers = await generateAIFavorLeastUsed(leastUsed, mostUsed, unusedNumbers, config.pickCount, config.mainPool, predictionAlgorithm);
                            break;
                        default:
                            mainNumbers = await generateAICombinedPrediction(mostUsed, leastUsed, unusedNumbers, config.pickCount, config.mainPool, predictionAlgorithm);
                            break;
                    }
                    
                    mainNumbers = [...new Set(mainNumbers)].slice(0, config.pickCount);
                    while (mainNumbers.length < config.pickCount) {
                        const randomNum = Math.floor(Math.random() * config.mainPool) + 1;
                        if (!mainNumbers.includes(randomNum)) {
                            mainNumbers.push(randomNum);
                        }
                    }

                    mainNumbers = _.shuffle(mainNumbers);
                    bonusNumbers = _.shuffle(bonusNumbers);
                    tickets.push({ numbers: mainNumbers.sort((a, b) => a - b), bonus: bonusNumbers.sort((a, b) => a - b), filter: advanceFilter, algorithm: predictionAlgorithm });
                }
            } catch (error) {
                console.error("Error generating advanced predictions:", error);
                showNotification("Error generating predictions. Please try again.");
            } finally {
                advancedPredictionLoading.classList.add('hidden');
            }

            const outputDiv = document.getElementById('advancedPredictionOutput');
            outputDiv.innerHTML = tickets.map((ticket, index) => `
                <div class="p-3 bg-white dark:bg-gray-600 rounded-lg mb-2 border border-gray-200 dark:border-gray-500">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium">Prediction ${index + 1} (Filter: ${ticket.filter.replace(/([A-Z])/g, ' $1').trim()}, Algo: ${ticket.algorithm.replace(/([A-Z])/g, ' $1').trim()})</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Sum: ${ticket.numbers.reduce((a, b) => a + b, 0)}</span>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-1">
                        ${ticket.numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${ticket.bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('')}
                    </div>
                </div>
            `).join('');

            showNotification('Generated advanced predictions!');
        }

        async function regenerateAdvancedPrediction() {
            if (!appState.lastPredictionConfig) {
                showNotification('No previous prediction to regenerate. Please generate a prediction first.');
                return;
            }
            // Re-run the generation with the stored configuration
            await generateAdvancedPrediction();
            showNotification('Regenerated advanced predictions!');
        }

        async function generateAICombinedPrediction(mostUsed, leastUsed, unusedNumbers, pickCount, mainPool, predictionAlgorithm) {
            let generatedNumbers = [];
            let algorithmHint = '';
            if (predictionAlgorithm === 'fisherYatesEnhanced') {
                algorithmHint = ' Ensure the selection process simulates a highly randomized shuffle, similar to a Fisher-Yates shuffle, to avoid any discernible patterns.';
            } else if (predictionAlgorithm === 'cryptoSecureEnhanced') {
                algorithmHint = ' Ensure the selection process is as unpredictable and secure as possible, mimicking cryptographically secure random number generation.';
            } else if (predictionAlgorithm === 'primeFilter') {
                algorithmHint = ' Prioritize prime numbers in the selection.';
            }

            const prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.
            Consider the following categories of numbers from a user's input:
            - Most Used Numbers: ${mostUsed.join(', ')}
            - Least Used Numbers: ${leastUsed.join(', ')}
            - Unused Numbers (from the full pool): ${unusedNumbers.join(', ')}
            
            Combine these categories intelligently to suggest a balanced set of numbers.${algorithmHint} Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40". Do not include any other text or explanation.`;

            return await callAIGeneration(prompt, pickCount, mainPool);
        }

        async function generateAIFavorUnused(unusedNumbers, mostUsed, leastUsed, pickCount, mainPool, predictionAlgorithm) {
             let algorithmHint = '';
            if (predictionAlgorithm === 'fisherYatesEnhanced') {
                algorithmHint = ' Ensure the selection process simulates a highly randomized shuffle, similar to a Fisher-Yates shuffle, to avoid any discernible patterns.';
            } else if (predictionAlgorithm === 'cryptoSecureEnhanced') {
                algorithmHint = ' Ensure the selection process is as unpredictable and secure as possible, mimicking cryptographically secure random number generation.';
            } else if (predictionAlgorithm === 'primeFilter') {
                algorithmHint = ' Prioritize prime numbers in the selection.';
            }
            const prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.
            Prioritize numbers from the 'unused numbers' list, but also consider numbers from 'most used' and 'least used' lists to create a diverse set.${algorithmHint}
            - Unused Numbers (from the full pool): ${unusedNumbers.join(', ')}
            - Most Used Numbers: ${mostUsed.join(', ')}
            - Least Used Numbers: ${leastUsed.join(', ')}
            Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40". Do not include any other text or explanation.`;

            return await callAIGeneration(prompt, pickCount, mainPool);
        }

        async function generateAIFavorMostUsed(mostUsed, unusedNumbers, leastUsed, pickCount, mainPool, predictionAlgorithm) {
            let algorithmHint = '';
            if (predictionAlgorithm === 'fisherYatesEnhanced') {
                algorithmHint = ' Ensure the selection process simulates a highly randomized shuffle, similar to a Fisher-Yates shuffle, to avoid any discernible patterns.';
            } else if (predictionAlgorithm === 'cryptoSecureEnhanced') {
                algorithmHint = ' Ensure the selection process is as unpredictable and secure as possible, mimicking cryptographically secure random number generation.';
            } else if (predictionAlgorithm === 'primeFilter') {
                algorithmHint = ' Prioritize prime numbers in the selection.';
            }
            const prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.
            Prioritize numbers from the 'most used' list, but also consider numbers from 'unused' and 'least used' lists to create a diverse set.${algorithmHint}
            - Most Used Numbers: ${mostUsed.join(', ')}
            - Unused Numbers (from the full pool): ${unusedNumbers.join(', ')}
            - Least Used Numbers: ${leastUsed.join(', ')}
            Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40". Do not include any other text or explanation.`;

            return await callAIGeneration(prompt, pickCount, mainPool);
        }

        async function generateAIFavorLeastUsed(leastUsed, mostUsed, unusedNumbers, pickCount, mainPool, predictionAlgorithm) {
            let algorithmHint = '';
            if (predictionAlgorithm === 'fisherYatesEnhanced') {
                algorithmHint = ' Ensure the selection process simulates a highly randomized shuffle, similar to a Fisher-Yates shuffle, to avoid any discernible patterns.';
            } else if (predictionAlgorithm === 'cryptoSecureEnhanced') {
                algorithmHint = ' Ensure the selection process is as unpredictable and secure as possible, mimicking cryptographically secure random number generation.';
            } else if (predictionAlgorithm === 'primeFilter') {
                algorithmHint = ' Prioritize prime numbers in the selection.';
            }
            const prompt = `Generate ${pickCount} unique lottery numbers between 1 and ${mainPool}.
            Prioritize numbers from the 'least used' list, but also consider numbers from 'most used' and 'unused' lists to create a diverse set.${algorithmHint}
            - Least Used Numbers: ${leastUsed.join(', ')}
            - Most Used Numbers: ${mostUsed.join(', ')}
            - Unused Numbers (from the full pool): ${unusedNumbers.join(', ')}
            Provide only the numbers as a comma-separated list, e.g., "1,5,12,23,40". Do not include any other text or explanation.`;

            return await callAIGeneration(prompt, pickCount, mainPool);
        }

        async function callAIGeneration(prompt, pickCount, mainPool) {
            let generatedNumbers = [];
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    const parsed = text.split(',').map(Number).filter(n => !isNaN(n) && n >= 1 && n <= mainPool);
                    generatedNumbers = [...new Set(parsed)];
                } else {
                    throw new Error("Invalid API response structure");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showNotification("AI generation failed. Using fallback.");
            }
            
            // Fallback to ensure correct count
            while (generatedNumbers.length < pickCount) {
                const randomNum = Math.floor(Math.random() * mainPool) + 1;
                if (!generatedNumbers.includes(randomNum)) {
                    generatedNumbers.push(randomNum);
                }
            }
            
            return generatedNumbers.slice(0, pickCount);
        }


        async function getAIInsights() {
            const input = document.getElementById('numbersToAnalyze').value;
            const numbers = parseNumbers(input);

            const aiInsightsOutput = document.getElementById('aiInsightsOutput');
            const aiInsightsText = document.getElementById('aiInsightsText');
            const aiInsightsLoading = document.getElementById('aiInsightsLoading');

            aiInsightsOutput.classList.remove('hidden');
            aiInsightsText.innerHTML = '';
            aiInsightsLoading.classList.remove('hidden');

            if (numbers.length === 0) {
                aiInsightsText.textContent = 'Please enter numbers to get AI insights.';
                aiInsightsLoading.classList.add('hidden');
                return;
            }

            const game = document.getElementById('analyzerGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('analyzerMainPool').value) || 69,
                pickCount: parseInt(document.getElementById('analyzerPickCount').value) || 5
            } : gameConfigs[game];

            const analysis = getNumberAnalysis(numbers, config.mainPool);

            let prompt = `Analyze the following lottery numbers for a ${game} game (main pool up to ${config.mainPool}, pick ${config.pickCount} numbers): ${numbers.join(', ')}.
            Their sum is ${analysis.sum}, average is ${analysis.avg.toFixed(2)}, with ${analysis.oddCount} odd and ${analysis.evenCount} even numbers.
            There are ${analysis.consecutivePairs} consecutive pairs, ${analysis.primes} prime numbers, and ${analysis.fibs} Fibonacci numbers.
            The standard deviation is ${analysis.stdDev.toFixed(2)} and the low/high ratio is ${analysis.lowHighRatio.toFixed(2)}.
            Provide an insightful, concise analysis of these numbers, highlighting any interesting patterns, strengths, or weaknesses for a lottery draw. Focus on common lottery number analysis concepts like balance, distribution, and historical trends if applicable.`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    aiInsightsText.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid API response structure");
                }
            } catch (error) {
                aiInsightsText.textContent = 'Error fetching AI insights.';
                console.error("Error calling Gemini API for AI insights:", error);
            } finally {
                aiInsightsLoading.classList.add('hidden');
            }
            showNotification('AI Insights generated!');
        }
        
        function getNumberAnalysis(numbers, mainPool) {
            const sum = numbers.reduce((a, b) => a + b, 0);
            const count = numbers.length;
            const avg = count > 0 ? sum / count : 0;
            const oddCount = numbers.filter(n => n % 2 === 1).length;
            const evenCount = count - oddCount;
            return {
                sum,
                count,
                avg,
                min: Math.min(...numbers),
                max: Math.max(...numbers),
                oddCount,
                evenCount,
                oddPercent: count > 0 ? (oddCount / count) * 100 : 0,
                evenPercent: count > 0 ? (evenCount / count) * 100 : 0,
                consecutivePairs: countConsecutivePairs(numbers),
                primes: numbers.filter(isPrime).length,
                fibs: numbers.filter(isFibonacci).length,
                gaps: calculateGaps(numbers),
                lastDigits: numbers.map(n => n % 10),
                stdDev: calculateStandardDeviation(numbers),
                spread: calculateSpread(numbers),
                lowHighRatio: calculateLowHighRatio(numbers, mainPool)
            };
        }

        function isPrime(num) {
            if (num < 2) return false;
            for (let i = 2, sqrt = Math.sqrt(num); i <= sqrt; i++) {
                if (num % i === 0) return false;
            }
            return true;
        }

        function isFibonacci(num) {
            return isPerfectSquare(5 * num * num + 4) || isPerfectSquare(5 * num * num - 4);
        }

        function isPerfectSquare(n) {
            const sqrt = Math.sqrt(n);
            return sqrt === Math.floor(sqrt);
        }

        function calculateGaps(numbers) {
            const sorted = [...numbers].sort((a, b) => a - b);
            const gaps = [];
            for (let i = 1; i < sorted.length; i++) {
                gaps.push(sorted[i] - sorted[i - 1]);
            }
            return gaps;
        }

        function calculateStandardDeviation(numbers) {
            if (numbers.length === 0) return 0;
            const avg = numbers.reduce((a, b) => a + b, 0) / numbers.length;
            const squareDiffs = numbers.map(n => Math.pow(n - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        function calculateSpread(numbers) {
            if (numbers.length < 2) return 0;
            const sorted = [...numbers].sort((a, b) => a - b);
            const range = sorted[sorted.length - 1] - sorted[0];
            return (range / (sorted.length - 1)) * 100;
        }

        function calculateLowHighRatio(numbers, mainPool) {
            if (numbers.length === 0) return 0;
            const mid = mainPool / 2;
            const low = numbers.filter(n => n <= mid).length;
            const high = numbers.length - low;
            return high > 0 ? low / high : low;
        }
        
        function detectUnusedFromInput(inputNumbers, mainPool) {
            const allPossibleNumbers = new Set(Array.from({ length: mainPool }, (_, i) => i + 1));
            const usedNumbers = new Set(inputNumbers);

            const unusedNumbers = [...allPossibleNumbers].filter(num => !usedNumbers.has(num));

            const allPossiblePairs = new Set();
            for (let i = 1; i <= mainPool; i++) {
                for (let j = i + 1; j <= mainPool; j++) {
                    allPossiblePairs.add(`${i}-${j}`);
                }
            }

            const usedPairs = new Set();
            const sortedInput = [...new Set(inputNumbers)].sort((a,b)=>a-b);
            for (let i = 0; i < sortedInput.length; i++) {
                for (let j = i + 1; j < sortedInput.length; j++) {
                    usedPairs.add(`${sortedInput[i]}-${sortedInput[j]}`);
                }
            }

            const unusedPairs = [...allPossiblePairs].filter(pair => !usedPairs.has(pair));

            return { unusedNumbers, unusedPairs };
        }


        function updateAnalyzerCharts(numbers) {
            const frequencyMap = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});
            
            const freqLabels = Object.keys(frequencyMap).sort((a, b) => a - b);
            const freqData = freqLabels.map(label => frequencyMap[label]);
            
            if (charts.freqDistributionChart) {
                charts.freqDistributionChart.data.labels = freqLabels;
                charts.freqDistributionChart.data.datasets[0].data = freqData;
                charts.freqDistributionChart.update();
            }
            
            const lastDigits = numbers.map(n => n % 10);
            const lastDigitCounts = Array(10).fill(0);
            lastDigits.forEach(digit => lastDigitCounts[digit]++);
            
            if (charts.lastDigitDistributionChart) {
                charts.lastDigitDistributionChart.data.labels = Array.from({length: 10}, (_, i) => i);
                charts.lastDigitDistributionChart.data.datasets[0].data = lastDigitCounts;
                charts.lastDigitDistributionChart.update();
            }
            
            const sum = numbers.reduce((a, b) => a + b, 0);
            if (charts.sumDistributionChart) {
                charts.sumDistributionChart.data.labels = ['Sum'];
                charts.sumDistributionChart.data.datasets[0].data = [sum];
                charts.sumDistributionChart.update();
            }
            
            const oddCount = numbers.filter(n => n % 2 === 1).length;
            const evenCount = numbers.length - oddCount;
            if (charts.oddEvenDistributionChart) {
                charts.oddEvenDistributionChart.data.labels = ['Odd', 'Even'];
                charts.oddEvenDistributionChart.data.datasets[0].data = [oddCount, evenCount];
                charts.oddEvenDistributionChart.update();
            }
        }

        function clearAnalyzer() {
            document.getElementById('numbersToAnalyze').value = '';
            document.getElementById('analysisResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers to analyze them</p>';
            
            ['basicStats', 'numberProps', 'patternStats', 'advancedMetrics', 'mostUsedNumbersInput', 'leastUsedNumbersInput', 'unusedNumbersAndPairs'].forEach(id => {
                document.getElementById(id).innerHTML = `<p>Analyze numbers to see results.</p>`;
            });
            
            document.getElementById('aiInsightsOutput').classList.add('hidden');
            document.getElementById('aiInsightsText').textContent = '';
            
            document.getElementById('advancedPredictionOutput').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate advanced predictions to see results here.</p>';
            document.getElementById('advancedPredictionLoading').classList.add('hidden');

            ['freqDistributionChart', 'lastDigitDistributionChart', 'sumDistributionChart', 'oddEvenDistributionChart'].forEach(id => {
                if(charts[id]) {
                    charts[id].data.labels = [];
                    charts[id].data.datasets[0].data = [];
                    charts[id].update();
                }
            });
            
            showNotification('Analyzer cleared!');
        }

        function clearAdvancedPrediction() {
            document.getElementById('advancedPredictionOutput').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate advanced predictions to see results here.</p>';
            document.getElementById('advancedPredictionLoading').classList.add('hidden');
            appState.lastPredictionConfig = null;
            showNotification('Advanced predictions cleared!');
        }

        // Combinatorics Lab Functions
        function findCommonPairs() {
            const input = document.getElementById('pairsDataInput').value;
            const minFrequency = parseInt(document.getElementById('minPairFrequency').value) || 2;
            const lines = input.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                showNotification('Please enter draw data.');
                return;
            }

            const pairCounts = {};
            lines.forEach(line => {
                const numbers = parseNumbers(line).sort((a, b) => a - b);
                if (numbers.length < 2) return;

                for (let i = 0; i < numbers.length; i++) {
                    for (let j = i + 1; j < numbers.length; j++) {
                        const pairKey = `${numbers[i]}-${numbers[j]}`;
                        pairCounts[pairKey] = (pairCounts[pairKey] || 0) + 1;
                    }
                }
            });

            const commonPairs = Object.entries(pairCounts)
                .filter(([_, count]) => count >= minFrequency)
                .sort((a, b) => b[1] - a[1]);

            const outputDiv = document.getElementById('commonPairsOutput');
            if (commonPairs.length === 0) {
                outputDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No common pairs found with the specified minimum frequency.</p>';
            } else {
                outputDiv.innerHTML = commonPairs.map(([pair, count]) => {
                    const [num1, num2] = pair.split('-');
                    return `
                        <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-600 rounded-lg mb-2">
                            <div class="flex gap-1">
                                <span class="number-ball">${num1}</span>
                                <span class="number-ball">${num2}</span>
                            </div>
                            <span class="font-bold text-lg text-primary">${count}x</span>
                        </div>
                    `;
                }).join('');
            }
            showNotification(`Found ${commonPairs.length} common pairs.`);
        }

        function useHistoricalDataForPairs() {
            if (appState.historicalData.length === 0) {
                showNotification('No historical data loaded. Please load data in the "Historical Data" tab first.');
                return;
            }

            const dataAsString = appState.historicalData.map(draw => draw.numbers.join(' ')).join('\n');
            document.getElementById('pairsDataInput').value = dataAsString;
            showNotification('Loaded historical data into the input.');
        }

        function clearPairsGenerator() {
            document.getElementById('pairsDataInput').value = '';
            document.getElementById('minPairFrequency').value = '2';
            document.getElementById('commonPairsOutput').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Find pairs to see results.</p>';
            showNotification('Pairs Generator cleared.');
        }

        function generateCombinations() {
            const input = document.getElementById('comboNumbersInput').value;
            const combinationSize = parseInt(document.getElementById('combinationSize').value);
            const numbers = [...new Set(parseNumbers(input))].sort((a, b) => a - b);

            if (numbers.length === 0 || isNaN(combinationSize) || combinationSize <= 0) {
                showNotification('Please enter a valid set of numbers and combination size.');
                return;
            }

            if (numbers.length < combinationSize) {
                showNotification('Combination size cannot be larger than the number of unique inputs.');
                return;
            }

            const combinations = getCombinations(numbers, combinationSize);
            const outputDiv = document.getElementById('combinationsOutput');
            const countSpan = document.getElementById('combinationCount');

            countSpan.textContent = combinations.length.toLocaleString();

            if (combinations.length === 0) {
                outputDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No combinations could be generated.</p>';
            } else {
                outputDiv.innerHTML = combinations.map(combo => {
                    return `
                        <div class="flex flex-wrap gap-1 p-2 border-b border-gray-200 dark:border-gray-600">
                            ${combo.map(num => `<span class="number-ball text-sm w-8 h-8">${num}</span>`).join('')}
                        </div>
                    `;
                }).join('');
            }
            showNotification(`Generated ${combinations.length.toLocaleString()} combinations.`);
        }

        function getCombinations(sourceArray, comboLength) {
            const results = [];
            
            function recurse(start, combo) {
                if (combo.length === comboLength) {
                    results.push(combo);
                    return;
                }
                if (start === sourceArray.length) {
                    return;
                }
                
                // Include sourceArray[start]
                recurse(start + 1, [...combo, sourceArray[start]]);
                
                // Exclude sourceArray[start]
                recurse(start + 1, combo);
            }
            
            recurse(0, []);
            return results;
        }

        function clearCombinationsGenerator() {
            document.getElementById('comboNumbersInput').value = '';
            document.getElementById('combinationSize').value = '3';
            document.getElementById('combinationsOutput').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate combinations to see results.</p>';
            document.getElementById('combinationCount').textContent = '0';
            showNotification('Combinations Generator cleared.');
        }

        function exportCombinationsTxt() {
            const combinationsDiv = document.getElementById('combinationsOutput');
            const combinationsText = Array.from(combinationsDiv.querySelectorAll('.flex.flex-wrap.gap-1')).map(div => {
                return Array.from(div.querySelectorAll('.number-ball')).map(ball => ball.textContent).join(',');
            }).join('\n');

            if (!combinationsText) {
                showNotification('No combinations to export!');
                return;
            }

            const blob = new Blob([combinationsText], { type: 'text/plain' });
            downloadBlob(blob, 'combinations.txt');
            showNotification('Combinations exported as TXT!');
        }

        function copyAllCombinations() {
            const combinationsDiv = document.getElementById('combinationsOutput');
            const combinationsText = Array.from(combinationsDiv.querySelectorAll('.flex.flex-wrap.gap-1')).map(div => {
                return Array.from(div.querySelectorAll('.number-ball')).map(ball => ball.textContent).join(',');
            }).join('\n');

            if (!combinationsText) {
                showNotification('No combinations to copy!');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = combinationsText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            showNotification('All combinations copied to clipboard!');
        }
        
        function parseNumbers(inputString) {
            return inputString.split(/[\s,;\-\n]+/).map(Number).filter(n => !isNaN(n) && n > 0);
        }

        // Reverse Engineering Functions
        async function reverseEngineerNumbers() {
            const input = document.getElementById('numbersToReverse').value;
            const numbers = parseNumbers(input);
            
            if (numbers.length === 0) {
                showNotification('Please enter valid numbers to reverse engineer!');
                return;
            }
            
            const game = document.getElementById('reverseGame').value;
            const config = gameConfigs[game];
            const method = document.getElementById('reverseMethod').value;
            
            const analysis = getNumberAnalysis(numbers, config.mainPool);
            
            document.getElementById('reverseStats').innerHTML = `
                <p>Count: ${analysis.count}</p>
                <p>Sum: ${analysis.sum}</p>
                <p>Average: ${analysis.avg.toFixed(2)}</p>
                <p>Odd/Even: ${analysis.oddCount}/${analysis.evenCount}</p>
                <p>Std Dev: ${analysis.stdDev.toFixed(2)}</p>
            `;
            
            document.getElementById('reversePatterns').innerHTML = `
                <p>Consecutive Pairs: ${analysis.consecutivePairs}</p>
                <p>Primes: ${analysis.primes}</p>
                <p>Fibonacci: ${analysis.fibs}</p>
                <p>Low/High Ratio: ${analysis.lowHighRatio.toFixed(2)}</p>
            `;
            
            let potentialSeeds = [];
            if (method === 'statistical') {
                potentialSeeds = generateStatisticalSeeds(numbers, config);
                document.getElementById('optimalCharacteristics').classList.add('hidden');
                document.getElementById('seedComparison').classList.add('hidden');
                displayPotentialSeeds(potentialSeeds);
            } else if (method === 'pattern') {
                potentialSeeds = generatePatternSeeds(numbers, config);
                document.getElementById('optimalCharacteristics').classList.add('hidden');
                document.getElementById('seedComparison').classList.add('hidden');
                displayPotentialSeeds(potentialSeeds);
            } else if (method === 'ai') {
                document.getElementById('optimalCharacteristics').classList.remove('hidden');
                document.getElementById('seedComparison').classList.remove('hidden');
                await getOptimalGameCharacteristics(numbers, config);
                await compareSeedToOptimal(numbers, config);
                await generateAISeeds(numbers, config);
            }
            
            updateReverseChart(numbers);
            updateSeedVisualsChart(numbers);
            
            document.getElementById('reverseResults').innerHTML = `
                <p class="font-medium">Reverse Engineering Complete (${method})</p>
                <p class="text-sm">Analyzed ${numbers.length} numbers with average ${analysis.avg.toFixed(2)}</p>
            `;
            
            showNotification('Reverse engineering completed!');
        }

        function generateStatisticalSeeds(numbers, config) {
            const sum = numbers.reduce((a, b) => a + b, 0);
            const avg = sum / numbers.length;
            const oddCount = numbers.filter(n => n % 2 === 1).length;
            
            const seeds = [
                sum,
                Math.round(avg * 100),
                oddCount * 1000 + numbers.length,
                parseInt(numbers.map(n => n % 10).join('')),
                parseInt(numbers.join('').slice(0, 10)),
                numbers.reduce((a, b) => a ^ b, 0) * 1000
            ].filter(seed => seed > 0 && !isNaN(seed));
            
            return [...new Set(seeds)];
        }

        function generatePatternSeeds(numbers, config) {
            const sorted = [...numbers].sort((a, b) => a - b);
            const gaps = calculateGaps(sorted);
            
            const seeds = [
                parseInt(gaps.join('')),
                parseInt(numbers.map(n => {
                    let factors = 0;
                    for (let i = 2; i <= n; i++) { if (n % i === 0) factors++; }
                    return factors;
                }).join('')),
                parseInt(numbers.map(n => String(n).split('').reduce((a, c) => a + parseInt(c), 0)).join('')),
                Math.round(numbers.reduce((a, b) => a + (b / config.mainPool), 0) * 10000)
            ].filter(seed => seed > 0 && !isNaN(seed));
            
            return [...new Set(seeds)];
        }

        async function generateAISeeds(numbers, config) {
            const reverseSeedsDiv = document.getElementById('reverseSeeds');
            reverseSeedsDiv.innerHTML = '<p>AI is analyzing for seeds... <span class="loading-indicator"></span></p>';
            
            try {
                const prompt = `Given these lottery numbers: ${numbers.join(', ')}, analyze them to suggest possible seed values or patterns that might generate similar numbers. Consider:
                - Statistical properties (sum, average, distribution)
                - Number patterns (consecutive, gaps, sequences)
                - Mathematical properties (primes, Fibonacci, digit sums)
                
                Provide 5-10 potential seed values or patterns that could generate similar numbers, with brief explanations. Format as a numbered list.`;
                
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const analysis = result.candidates[0].content.parts[0].text;
                    reverseSeedsDiv.innerHTML = `
                        <p class="font-medium">AI Seed Analysis</p>
                        <div class="text-xs mt-2">${analysis.replace(/\n/g, '<br>')}</div>
                    `;
                } else {
                    throw new Error("Invalid API response for seeds");
                }
            } catch (error) {
                console.error("Error calling Gemini API for reverse engineering:", error);
                reverseSeedsDiv.innerHTML = '<p class="text-red-500">Error during AI analysis.</p>';
            }
        }

        async function getOptimalGameCharacteristics(numbers, config) {
            const optimalCharacteristicsText = document.getElementById('optimalCharacteristicsText');
            const optimalCharacteristicsLoading = document.getElementById('optimalCharacteristicsLoading');
            optimalCharacteristicsLoading.classList.remove('hidden');
            optimalCharacteristicsText.innerHTML = '';

            const prompt = `Given the lottery game configuration (main pool up to ${config.mainPool}, pick ${config.pickCount} numbers) and the following input numbers: ${numbers.join(', ')}.
            Based on common lottery strategies and statistical balance, describe the "optimal" characteristics for a set of ${config.pickCount} numbers for this game.
            Consider aspects like:
            - Ideal sum range
            - Balanced odd/even ratio
            - Maximum number of consecutive numbers
            - Ideal count of prime numbers
            - Ideal count of Fibonacci numbers
            - Balanced distribution across number groups (e.g., 1-10, 11-20, etc.)

            Provide a concise description of these optimal characteristics.`;

            try {
                 let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    optimalCharacteristicsText.textContent = result.candidates[0].content.parts[0].text;
                } else { throw new Error("Invalid API response for optimal characteristics"); }
            } catch (error) {
                optimalCharacteristicsText.textContent = 'Error fetching optimal characteristics.';
                console.error("Error calling Gemini API for optimal characteristics:", error);
            } finally {
                optimalCharacteristicsLoading.classList.add('hidden');
            }
        }

        async function compareSeedToOptimal(numbers, config) {
            const seedComparisonText = document.getElementById('seedComparisonText');
            const seedComparisonLoading = document.getElementById('seedComparisonLoading');
            seedComparisonLoading.classList.remove('hidden');
            seedComparisonText.innerHTML = '';

            const analysis = getNumberAnalysis(numbers, config.mainPool);

            const prompt = `Given the following lottery numbers: ${numbers.join(', ')}.
            Their sum is ${analysis.sum}, odd numbers: ${analysis.oddCount}, even numbers: ${analysis.evenCount}, consecutive pairs: ${analysis.consecutivePairs}, prime numbers: ${analysis.primes}, Fibonacci numbers: ${analysis.fibs}.
            Considering a lottery game with a main pool up to ${config.mainPool} and picking ${config.pickCount} numbers, how do these numbers compare to statistically "optimal" or "balanced" lottery numbers for this game type?
            Highlight strengths and weaknesses based on common lottery number analysis.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    seedComparisonText.textContent = result.candidates[0].content.parts[0].text;
                } else { throw new Error("Invalid API response for comparison"); }
            } catch (error) {
                seedComparisonText.textContent = 'Error fetching comparison to optimal.';
                console.error("Error calling Gemini API for comparison:", error);
            } finally {
                seedComparisonLoading.classList.add('hidden');
            }
        }


        function displayPotentialSeeds(seeds) {
            const seedsDiv = document.getElementById('reverseSeeds');
            if (seeds.length === 0) {
                seedsDiv.innerHTML = '<p>No potential seeds identified</p>';
                return;
            }
            
            seedsDiv.innerHTML = `
                <p>Potential seed values identified:</p>
                <div class="flex flex-wrap gap-1 mt-2">
                    ${seeds.map(seed => `<span class="number-ball">${seed}</span>`).join('')}
                </div>
                <p class="mt-2 text-xs">Try these as seeds in the generator</p>
            `;
        }

        function updateReverseChart(numbers) {
            const frequencyMap = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});
            
            const labels = Object.keys(frequencyMap).sort((a, b) => a - b);
            const data = labels.map(label => frequencyMap[label]);
            
            if(charts.reverseChart) {
                charts.reverseChart.data.labels = labels;
                charts.reverseChart.data.datasets[0].data = data;
                charts.reverseChart.update();
            }
        }

        function updateSeedVisualsChart(numbers) {
            const frequencyMap = numbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});
            
            const labels = Object.keys(frequencyMap).sort((a, b) => a - b);
            const data = labels.map(label => frequencyMap[label]);
            
            if(charts.seedVisualsChart) {
                charts.seedVisualsChart.data.labels = labels;
                charts.seedVisualsChart.data.datasets[0].data = data;
                charts.seedVisualsChart.update();
            }
        }

        function clearReverseEngineer() {
            document.getElementById('numbersToReverse').value = '';
            document.getElementById('reverseResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Enter numbers and analyze to see results</p>';
            document.getElementById('reverseStats').innerHTML = '';
            document.getElementById('reversePatterns').innerHTML = '';
            document.getElementById('reverseSeeds').innerHTML = '<p>Analyze numbers to see potential seed values</p>';
            
            document.getElementById('optimalCharacteristics').classList.add('hidden');
            document.getElementById('seedComparison').classList.add('hidden');

            if(charts.reverseChart) {
                charts.reverseChart.data.labels = [];
                charts.reverseChart.data.datasets[0].data = [];
                charts.reverseChart.update();
            }

            if(charts.seedVisualsChart) {
                charts.seedVisualsChart.data.labels = [];
                charts.seedVisualsChart.data.datasets[0].data = [];
                charts.seedVisualsChart.update();
            }
            
            showNotification('Reverse engineer cleared!');
        }

        // Historical Data Functions
        function loadHistoricalData() {
            const source = document.getElementById('dataSource').value;
            const game = document.getElementById('historicalGame').value;
            let config;

            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            if (source === 'sample') {
                const drawCount = parseInt(document.getElementById('pastDraws').value) || 50;
                appState.historicalData = Array.from({ length: drawCount }, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (drawCount - i));
                    
                    return {
                        date: date.toISOString().split('T')[0],
                        numbers: [...new Set(Array.from({ length: config.pickCount }, () => Math.floor(Math.random() * config.mainPool) + 1))].sort((a, b) => a - b),
                        bonus: [...new Set(Array.from({ length: config.bonusCount }, () => Math.floor(Math.random() * config.bonusPool) + 1))]
                    };
                });
                
                displayHistoricalData();
                updateHistoricalCharts();
                showNotification(`Loaded ${drawCount} sample draws for ${game}`);
                
            } else if (source === 'csv') {
                const file = document.getElementById('csvUpload').files[0];
                if (!file) {
                    showNotification('Please select a CSV file first!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        showNotification('CSV file is empty or has invalid format!');
                        return;
                    }
                    
                    appState.historicalData = lines.slice(1).map(line => {
                        const [date, ...nums] = line.split(',');
                        const numbers = nums.slice(0, config.pickCount).map(Number).filter(n => !isNaN(n));
                        const bonus = nums.slice(config.pickCount, config.pickCount + config.bonusCount).map(Number).filter(n => !isNaN(n));
                        
                        return {
                            date: date || new Date().toISOString().split('T')[0],
                            numbers: numbers.sort((a, b) => a - b),
                            bonus: bonus
                        };
                    }).filter(draw => draw.numbers.length === config.pickCount && draw.bonus.length === config.bonusCount);
                    
                    if (appState.historicalData.length === 0) {
                        showNotification('No valid draws found in CSV!');
                        return;
                    }
                    
                    const pastDraws = document.getElementById('pastDraws').value;
                    if (pastDraws !== 'all') {
                        appState.historicalData = appState.historicalData.slice(-parseInt(pastDraws));
                    }
                    
                    appState.currentPage = 1;
                    displayHistoricalData();
                    updateHistoricalCharts();
                    showNotification(`Loaded ${appState.historicalData.length} draws from CSV`);
                };
                
                reader.readAsText(file);
            } else if (source === 'manual') { // Handle manual input
                const input = document.getElementById('manualDrawsInput').value;
                const lines = input.split('\n').filter(line => line.trim());

                if (lines.length === 0) {
                    showNotification('Please enter manual draw data!');
                    return;
                }

                appState.historicalData = lines.map(line => {
                    const parts = line.split(',');
                    if (parts.length < config.pickCount + config.bonusCount + 1) {
                        console.warn(`Skipping malformed line: ${line}`);
                        return null; // Skip invalid lines
                    }
                    const date = parts[0].trim();
                    const numbers = parts.slice(1, 1 + config.pickCount).map(Number).filter(n => !isNaN(n));
                    const bonus = parts.slice(1 + config.pickCount, 1 + config.pickCount + config.bonusCount).map(Number).filter(n => !isNaN(n));

                    return {
                        date: date || new Date().toISOString().split('T')[0],
                        numbers: numbers.sort((a, b) => a - b),
                        bonus: bonus
                    };
                }).filter(draw => draw !== null && draw.numbers.length === config.pickCount && draw.bonus.length === config.bonusCount);

                if (appState.historicalData.length === 0) {
                    showNotification('No valid draws found in manual input! Ensure format is Date,N1,N2,...,B1,...');
                    return;
                }

                const pastDraws = document.getElementById('pastDraws').value;
                if (pastDraws !== 'all') {
                    appState.historicalData = appState.historicalData.slice(-parseInt(pastDraws));
                }
                
                appState.currentPage = 1;
                displayHistoricalData();
                updateHistoricalCharts();
                showNotification(`Loaded ${appState.historicalData.length} draws from manual input`);
            }
        }

        function displayHistoricalData() {
            const tableBody = document.getElementById('historicalTable').querySelector('tbody');
            
            if (appState.historicalData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500 dark:text-gray-400">Load data to view historical draws</td></tr>`;
                document.getElementById('paginationInfo').textContent = 'Showing 0 of 0';
                document.getElementById('prevPage').disabled = true;
                document.getElementById('nextPage').disabled = true;
                return;
            }
            
            const start = (appState.currentPage - 1) * appState.drawsPerPage;
            const end = start + appState.drawsPerPage;
            const paginatedData = appState.historicalData.slice(start, end);
            
            tableBody.innerHTML = paginatedData.map(draw => `
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                    <td class="p-2">${draw.date}</td>
                    <td class="p-2"><div class="flex flex-wrap gap-1">${draw.numbers.map(n => `<span class="number-ball">${n}</span>`).join('')}</div></td>
                    <td class="p-2"><div class="flex flex-wrap gap-1">${draw.bonus.map(n => `<span class="number-ball bonus-ball">${n}</span>`).join('')}</div></td>
                    <td class="p-2">${draw.numbers.reduce((a, b) => a + b, 0)}</td>
                    <td class="p-2">${draw.numbers.filter(n => n % 2 === 1).length} Odd / ${draw.numbers.filter(n => n % 2 === 0).length} Even</td>
                </tr>
            `).join('');
            
            document.getElementById('paginationInfo').textContent = `Showing ${start + 1}-${Math.min(end, appState.historicalData.length)} of ${appState.historicalData.length}`;
            document.getElementById('prevPage').disabled = appState.currentPage === 1;
            document.getElementById('nextPage').disabled = end >= appState.historicalData.length;
            
            updateDataSummary();
        }

        function updateDataSummary() {
            if (appState.historicalData.length === 0) {
                document.getElementById('dataSummary').innerHTML = '<p class="text-gray-500 dark:text-gray-400">No data loaded</p>';
                ['mostFrequent', 'leastFrequent', 'dueNumbers', 'recentTrends', 'patternFrequency', 'sumStatistics'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                return;
            }
            
            const frequency = getNumberFrequency();
            const gaps = getGapAnalysis();
            
            const mostFrequent = Object.entries(frequency).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([num, count]) => `${num} (${count}x)`);
            document.getElementById('mostFrequent').innerHTML = mostFrequent.join(', ');
            
            const leastFrequent = Object.entries(frequency).sort((a, b) => a[1] - b[1]).slice(0, 5).map(([num, count]) => `${num} (${count}x)`);
            document.getElementById('leastFrequent').innerHTML = leastFrequent.join(', ');
            
            const dueNumbers = Object.entries(gaps).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([num, gap]) => `${num} (${gap} draws)`);
            document.getElementById('dueNumbers').innerHTML = dueNumbers.join(', ');
            
            const recentDraws = appState.historicalData.slice(-10);
            const recentNumbers = recentDraws.flatMap(d => d.numbers);
            const recentFrequency = recentNumbers.reduce((acc, num) => {
                acc[num] = (acc[num] || 0) + 1;
                return acc;
            }, {});
            
            const hotRecent = Object.entries(recentFrequency).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([num, count]) => `${num} (${count}x)`);
            document.getElementById('recentTrends').innerHTML = hotRecent.length > 0 ? hotRecent.join(', ') : 'No recent trends detected';
            
            const patternCounts = recentDraws.map(d => countConsecutivePairs(d.numbers));
            const avgPatterns = patternCounts.reduce((a, b) => a + b, 0) / patternCounts.length;
            document.getElementById('patternFrequency').innerHTML = `Avg consecutive pairs (last 10): ${avgPatterns.toFixed(2)}`;
            
            const sums = appState.historicalData.map(d => d.numbers.reduce((a, b) => a + b, 0));
            const minSum = Math.min(...sums);
            const maxSum = Math.max(...sums);
            const avgSum = sums.reduce((a, b) => a + b, 0) / sums.length;
            document.getElementById('sumStatistics').innerHTML = `<p>Min: ${minSum}</p><p>Max: ${maxSum}</p><p>Avg: ${avgSum.toFixed(2)}</p>`;
            
            const firstDate = appState.historicalData[0].date;
            const lastDate = appState.historicalData[appState.historicalData.length - 1].date;
            document.getElementById('dataSummary').innerHTML = `<p>Total Draws: ${appState.historicalData.length}</p><p>Date Range: ${firstDate} to ${lastDate}</p><p>Avg Sum: ${avgSum.toFixed(2)}</p>`;
        }

        function updateHistoricalCharts() {
            if (appState.historicalData.length === 0) {
                ['freqHeatmapChart', 'freqOverTimeChart', 'gapAnalysisChart'].forEach(id => {
                    if (charts[id]) {
                        charts[id].data.labels = [];
                        charts[id].data.datasets[0].data = [];
                        charts[id].update();
                    }
                });
                return;
            }
            
            const frequency = getNumberFrequency();
            const gaps = getGapAnalysis();
            
            const heatmapLabels = Object.keys(frequency).sort((a, b) => a - b);
            const heatmapData = heatmapLabels.map(label => frequency[label]);
            if (charts.freqHeatmapChart) {
                charts.freqHeatmapChart.data.labels = heatmapLabels;
                charts.freqHeatmapChart.data.datasets[0].data = heatmapData;
                charts.freqHeatmapChart.update();
            }
            
            const timeLabels = appState.historicalData.map((_, i) => i + 1);
            const timeData = appState.historicalData.map(d => d.numbers.reduce((a, b) => a + b, 0));
            if (charts.freqOverTimeChart) {
                charts.freqOverTimeChart.data.labels = timeLabels;
                charts.freqOverTimeChart.data.datasets[0].data = timeData;
                charts.freqOverTimeChart.update();
            }
            
            const gapLabels = Object.keys(gaps).sort((a, b) => a - b);
            const gapData = gapLabels.map(label => gaps[label]);
            if (charts.gapAnalysisChart) {
                charts.gapAnalysisChart.data.labels = gapLabels;
                charts.gapAnalysisChart.data.datasets[0].data = gapData;
                charts.gapAnalysisChart.update();
            }
        }

        function getNumberFrequency() {
            const frequency = {};
            appState.historicalData.forEach(draw => {
                draw.numbers.forEach(num => {
                    frequency[num] = (frequency[num] || 0) + 1;
                });
            });
            return frequency;
        }

        function getGapAnalysis() {
            const gaps = {};
            const game = document.getElementById('historicalGame').value;
            // Use the config from the currently selected game, including custom if active
            let currentConfig;
            if (game === 'custom') {
                currentConfig = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                currentConfig = gameConfigs[game];
            }
            const mainPool = currentConfig.mainPool;
            
            for (let i = 1; i <= mainPool; i++) { gaps[i] = appState.historicalData.length; }
            
            const lastSeenIndex = {};
            appState.historicalData.forEach((draw, index) => {
                draw.numbers.forEach(num => { lastSeenIndex[num] = index; });
            });

            for (let i = 1; i <= mainPool; i++) {
                if (lastSeenIndex[i] !== undefined) {
                    gaps[i] = appState.historicalData.length - 1 - lastSeenIndex[i];
                }
            }
            return gaps;
        }

        function prevPage() {
            if (appState.currentPage > 1) {
                appState.currentPage--;
                displayHistoricalData();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(appState.historicalData.length / appState.drawsPerPage);
            if (appState.currentPage < totalPages) {
                appState.currentPage++;
                displayHistoricalData();
            }
        }

        function clearHistoricalData() {
            appState.historicalData = [];
            appState.currentPage = 1;
            displayHistoricalData();
            updateHistoricalCharts();
            showNotification('Historical data cleared!');
        }

        function exportHistoricalData() {
            if (appState.historicalData.length === 0) {
                showNotification('No historical data to export!');
                return;
            }
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            const csvData = [
                ['Date', ...Array.from({ length: config.pickCount }, (_, i) => `Number${i + 1}`), ...Array.from({ length: config.bonusCount }, (_, i) => `Bonus${i + 1}`)],
                ...appState.historicalData.map(draw => [draw.date, ...draw.numbers, ...draw.bonus])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv' });
            downloadBlob(blob, 'historical_data.csv');
            showNotification('Historical data exported as CSV!');
        }

        // Strategy Functions
        function applyStrategy(e) {
            const strategy = e.target.dataset.strategy;
            
            if (appState.historicalData.length === 0) {
                showNotification('Load historical data first to apply strategies!');
                return;
            }
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            let recommendedNumbers = [];
            
            switch (strategy) {
                case 'frequency':
                    const frequency = getNumberFrequency();
                    recommendedNumbers = Object.entries(frequency).sort((a, b) => b[1] - a[1]).slice(0, config.pickCount * 2).map(([num]) => parseInt(num));
                    break;
                case 'gap':
                    const gaps = getGapAnalysis();
                    recommendedNumbers = Object.entries(gaps).sort((a, b) => b[1] - a[1]).slice(0, config.pickCount * 2).map(([num]) => parseInt(num));
                    break;
                case 'pattern':
                    const pairFrequency = getPairFrequency();
                    const topPairs = Object.entries(pairFrequency).sort((a, b) => b[1] - a[1]).slice(0, 5);
                    recommendedNumbers = [...new Set(topPairs.flatMap(([pair]) => pair.split('-').map(Number)))];
                    break;
            }
            
            recommendedNumbers = [...new Set(recommendedNumbers)].slice(0, config.pickCount);

            document.getElementById('strategyResults').innerHTML = `<p class="font-medium">${strategy.charAt(0).toUpperCase() + strategy.slice(1)} Strategy Applied</p><p class="text-sm">Recommended numbers based on historical data analysis</p>`;
            document.getElementById('recommendedNumbers').innerHTML = recommendedNumbers.sort((a, b) => a - b).map(num => `<span class="number-ball">${num}</span>`).join('');
            document.getElementById('strategyAnalysis').innerHTML = `<p>Numbers recommended: ${recommendedNumbers.length}</p><p>Strategy: ${strategy}</p><p>Draws analyzed: ${appState.historicalData.length}</p>`;
            
            showNotification(`${strategy} strategy applied successfully!`);
        }

        function buildCustomStrategy() {
            if (appState.historicalData.length === 0) {
                showNotification('Load historical data first to build custom strategy!');
                return;
            }
            
            const components = Array.from(document.querySelectorAll('.strategyComponent:checked')).map(el => el.value);
            if (components.length === 0) {
                showNotification('Select at least one strategy component!');
                return;
            }
            
            const weights = {
                frequency: parseInt(document.getElementById('freqWeight').value) / 100,
                gap: parseInt(document.getElementById('gapWeight').value) / 100,
                pattern: parseInt(document.getElementById('patternWeight').value) / 100,
                other: parseInt(document.getElementById('otherWeight').value) / 100
            };
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            const mainPool = config.mainPool;
            
            const candidates = Array.from({ length: mainPool }, (_, i) => i + 1);
            
            const frequency = components.includes('frequency') ? getNumberFrequency() : {};
            const gaps = components.includes('gap') ? getGapAnalysis() : {};
            const pairFrequency = components.includes('pattern') ? getPairFrequency() : {};
            
            const scoredNumbers = candidates.map(num => {
                let score = 0;
                if (components.includes('frequency')) {
                    const maxFreq = Math.max(...Object.values(frequency), 1);
                    score += ((frequency[num] || 0) / maxFreq) * weights.frequency;
                }
                if (components.includes('gap')) {
                    const maxGap = Math.max(...Object.values(gaps), 1);
                    score += ((gaps[num] || 0) / maxGap) * weights.gap;
                }
                if (components.includes('pattern')) {
                    let patternScore = 0;
                    for (const pair in pairFrequency) { if (pair.includes(String(num))) patternScore += pairFrequency[pair]; }
                    const maxPairFreq = Math.max(...Object.values(pairFrequency), 1);
                    score += (patternScore / maxPairFreq) * weights.pattern;
                }
                if (components.includes('prime') && isPrime(num)) score += weights.other;
                if (components.includes('fibonacci') && isFibonacci(num)) score += weights.other;
                score += Math.random() * 0.01;
                return { num, score };
            });
            
            const recommendedNumbers = scoredNumbers.sort((a, b) => b.score - a.score).slice(0, config.pickCount).map(item => item.num);
            
            document.getElementById('strategyResults').innerHTML = `<p class="font-medium">Custom Strategy Applied</p><p class="text-sm">Recommended numbers based on your custom strategy</p>`;
            document.getElementById('recommendedNumbers').innerHTML = recommendedNumbers.sort((a, b) => a - b).map(num => `<span class="number-ball">${num}</span>`).join('');
            document.getElementById('strategyAnalysis').innerHTML = `<p>Components: ${components.join(', ')}</p><p>Weights: Freq(${(weights.frequency*100).toFixed(0)}%), Gap(${(weights.gap*100).toFixed(0)}%), Pattern(${(weights.pattern*100).toFixed(0)}%), Other(${(weights.other*100).toFixed(0)}%)</p>`;
            
            showNotification('Custom strategy applied successfully!');
        }

        function getPairFrequency() {
            const pairFrequency = {};
            appState.historicalData.forEach(draw => {
                const nums = draw.numbers;
                for (let i = 0; i < nums.length; i++) {
                    for (let j = i + 1; j < nums.length; j++) {
                        const key = `${Math.min(nums[i], nums[j])}-${Math.max(nums[i], nums[j])}`;
                        pairFrequency[key] = (pairFrequency[key] || 0) + 1;
                    }
                }
            });
            return pairFrequency;
        }

        function updateStrategyWeights() {
            const checkedComponents = Array.from(document.querySelectorAll('.strategyComponent:checked'));
            
            ['freqWeight', 'gapWeight', 'patternWeight', 'otherWeight'].forEach(id => document.getElementById(id).value = 0);
            
            if (checkedComponents.length > 0) {
                const weightPerComponent = 100 / checkedComponents.length;
                checkedComponents.forEach(comp => {
                    let targetId = 'otherWeight';
                    if (comp.value === 'frequency') targetId = 'freqWeight';
                    else if (comp.value === 'gap') targetId = 'gapWeight';
                    else if (comp.value === 'pattern') targetId = 'patternWeight';
                    
                    const el = document.getElementById(targetId);
                    el.value = parseFloat(el.value) + weightPerComponent;
                });
            }
            updateStrategyWeightValues();
        }

        function updateStrategyWeightValues() {
            document.getElementById('freqWeightValue').textContent = Math.round(document.getElementById('freqWeight').value) + '%';
            document.getElementById('gapWeightValue').textContent = Math.round(document.getElementById('gapWeight').value) + '%';
            document.getElementById('patternWeightValue').textContent = Math.round(document.getElementById('patternWeight').value) + '%';
            document.getElementById('otherWeightValue').textContent = Math.round(document.getElementById('otherWeight').value) + '%';
        }

        // Probability Functions
        function calculateProbabilities() {
            const game = document.getElementById('probabilityGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('probMainPool').value) || 69,
                pickCount: parseInt(document.getElementById('probPickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('probBonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('probBonusCount').value) || 1
            } : gameConfigs[game];
            
            const tickets = parseInt(document.getElementById('ticketsToPlay').value) || 1;
            const jackpot = parseFloat(document.getElementById('jackpotSize').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            const mainCombinations = combinations(config.mainPool, config.pickCount);
            const bonusCombinations = combinations(config.bonusPool, config.bonusCount);
            const totalCombinations = mainCombinations * bonusCombinations;
            
            const chancePerTicket = 1 / totalCombinations;
            const chanceWithTickets = 1 - Math.pow(1 - chancePerTicket, tickets);
            
            const afterTaxJackpot = jackpot * (1 - taxRate / 100);
            const expectedValue = afterTaxJackpot / totalCombinations;
            
            document.getElementById('probResults').innerHTML = `<p class="font-medium">Probability Analysis</p><p class="text-sm">Calculated for ${game} with ${tickets} ticket${tickets > 1 ? 's' : ''}</p>`;
            document.getElementById('basicProbs').innerHTML = `<p>Total combinations: ${totalCombinations.toLocaleString()}</p><p>Chance per ticket: 1 in ${totalCombinations.toLocaleString()}</p><p>Chance with ${tickets} ticket${tickets > 1 ? 's' : ''}: ${(chanceWithTickets * 100).toExponential(4)}%</p>`;
            document.getElementById('winChances').innerHTML = `<p>Match all: 1 in ${totalCombinations.toLocaleString()}</p><p>Match ${config.pickCount - 1} + bonus: ~1 in ${Math.round(totalCombinations / (config.pickCount * config.bonusCount)).toLocaleString()}</p>`;
            document.getElementById('expectedValue').textContent = `$${expectedValue.toFixed(2)}`;
            
            updateProbabilityChart(totalCombinations, tickets);
            updateProbabilityComparisons(totalCombinations);
            showNotification('Probability calculation completed!');
        }

        function combinations(n, k) {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            if (k > n / 2) k = n - k;
            let result = 1;
            for (let i = 1; i <= k; i++) {
                result = result * (n - i + 1) / i;
            }
            return Math.round(result);
        }

        function updateProbabilityChart(totalCombinations, tickets) {
            const labels = [];
            const data = [];
            for (let i = 1; i <= 10; i++) {
                const currentTickets = i * tickets;
                const prob = 1 - Math.pow(1 - (1 / totalCombinations), currentTickets);
                labels.push(currentTickets);
                data.push(prob * 100);
            }
            if(charts.probDistributionChart) {
                charts.probDistributionChart.data.labels = labels;
                charts.probDistributionChart.data.datasets[0].data = data;
                charts.probDistributionChart.update();
            }
        }

        function updateProbabilityComparisons(totalCombinations) {
            const comparisons = {
                'Coin Flip (Heads)': 2,
                'Royal Flush (Poker)': 649740,
                'Being Struck by Lightning': 13884900,
                'Winning an Oscar': 11500,
                'Becoming a Billionaire': 2000000
            };
            
            let html = '';
            for (const [event, odds] of Object.entries(comparisons)) {
                const ratio = (totalCombinations / odds);
                html += `<p>${event}: ${ratio.toLocaleString(undefined, {maximumFractionDigits: 1})}x ${ratio > 1 ? 'less' : 'more'} likely</p>`;
            }
            document.getElementById('probComparisons').innerHTML = html;
            
            const jackpot = parseFloat(document.getElementById('jackpotSize').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const afterTax = jackpot * (1 - taxRate / 100);
            const breakEven = totalCombinations;
            document.getElementById('investmentAnalysis').innerHTML = `<p>Break-even jackpot: $${breakEven.toLocaleString()}</p><p>After-tax value: $${afterTax.toLocaleString()}</p><p>Expected return: ${((afterTax / breakEven) * 100).toFixed(2)}%</p>`;
        }

        function resetProbabilityCalculator() {
            document.getElementById('ticketsToPlay').value = '1';
            document.getElementById('jackpotSize').value = '';
            document.getElementById('taxRate').value = '';
            document.getElementById('probResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Calculate probabilities to see results</p>';
            ['basicProbs', 'winChances', 'probComparisons', 'investmentAnalysis'].forEach(id => document.getElementById(id).innerHTML = '');
            document.getElementById('expectedValue').textContent = '$0.00';
            if(charts.probDistributionChart) {
                charts.probDistributionChart.data.labels = [];
                charts.probDistributionChart.data.datasets[0].data = [];
                charts.probDistributionChart.update();
            }
            showNotification('Probability calculator reset!');
        }

        function exportProbabilityResults() {
            const game = document.getElementById('probabilityGame').value;
            const config = game === 'custom' ? {
                mainPool: parseInt(document.getElementById('probMainPool').value) || 69,
                pickCount: parseInt(document.getElementById('probPickCount').value) || 5,
                bonusPool: parseInt(document.getElementById('probBonusPool').value) || 26,
                bonusCount: parseInt(document.getElementById('probBonusCount').value) || 1
            } : gameConfigs[game];
            
            const tickets = parseInt(document.getElementById('ticketsToPlay').value) || 1;
            const jackpot = parseFloat(document.getElementById('jackpotSize').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            const mainCombinations = combinations(config.mainPool, config.pickCount);
            const bonusCombinations = combinations(config.bonusPool, config.bonusCount);
            const totalCombinations = mainCombinations * bonusCombinations;
            
            const chancePerTicket = 1 / totalCombinations;
            const chanceWithTickets = 1 - Math.pow(1 - chancePerTicket, tickets);
            const afterTaxJackpot = jackpot * (1 - taxRate / 100);
            const expectedValue = afterTaxJackpot / totalCombinations;
            
            const data = [
                ['Parameter', 'Value'],
                ['Game', game],
                ['Total Combinations', totalCombinations.toLocaleString()],
                ['Tickets Played', tickets],
                ['Chance with Tickets (%)', (chanceWithTickets * 100).toExponential(4)],
                ['Expected Value ($)', expectedValue.toFixed(2)]
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([data], { type: 'text/csv' });
            downloadBlob(blob, 'probability_analysis.csv');
            showNotification('Probability results exported as CSV!');
        }

        // Prediction Functions
        function generatePrediction() {
            if (appState.historicalData.length === 0) {
                showNotification('Load historical data first to generate predictions!');
                return;
            }
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            const { numbers, bonus, confidence, scoredNumbers } = generatePredictionData(config);
            
            document.getElementById('predictionResults').innerHTML = `<p class="font-medium">Next Draw Prediction</p><p class="text-sm">Predicted numbers based on historical data analysis</p>`;
            document.getElementById('predictedNumbers').innerHTML = numbers.map(num => `<span class="number-ball">${num}</span>`).join('') + bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('');
            document.getElementById('confidenceScores').innerHTML = `<p>Confidence: ${confidence}%</p>`;
            
            updatePredictionChart(numbers, scoredNumbers);
            showNotification('Prediction generated successfully!');
        }

        function forecastDraws() {
            if (appState.historicalData.length === 0) {
                showNotification('Load historical data first to generate forecasts!');
                return;
            }
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            let forecast = '';
            for (let i = 1; i <= 40; i++) {
                const prediction = generatePredictionData(config);
                forecast += `<div class="mb-4"><p class="font-medium">Draw ${i}</p><div class="flex flex-wrap gap-1 my-2">${prediction.numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}${prediction.bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('')}</div><p class="text-sm">Confidence: ${prediction.confidence}%</p></div>`;
            }
            
            document.getElementById('predictionResults').innerHTML = `<p class="font-medium">Next 40 Draws Forecast</p><p class="text-sm">Predicted numbers for upcoming draws</p>${forecast}`;
            document.getElementById('predictedNumbers').innerHTML = '';
            document.getElementById('confidenceScores').innerHTML = '';
            
            showNotification('40-draw forecast generated successfully!');
        }

        function generatePredictionData(config) {
            const frequency = getNumberFrequency();
            const gaps = getGapAnalysis();
            
            const scoredNumbers = Object.keys(frequency).map(numStr => {
                const num = parseInt(numStr);
                const maxFreq = Math.max(...Object.values(frequency), 1);
                const maxGap = Math.max(...Object.values(gaps), 1);
                const freqScore = (frequency[num] || 0) / maxFreq;
                const gapScore = (gaps[num] || 0) / maxGap;
                return { num, score: freqScore * 0.6 + gapScore * 0.4 + Math.random() * 0.1 };
            });
            
            const numbers = _.shuffle(scoredNumbers).sort((a, b) => b.score - a.score).slice(0, config.pickCount).map(item => item.num).sort((a, b) => a - b);
            
            const bonusFrequency = appState.historicalData.reduce((acc, draw) => {
                draw.bonus.forEach(num => { acc[num] = (acc[num] || 0) + 1; });
                return acc;
            }, {});
            
            const bonus = _.shuffle(Object.entries(bonusFrequency)).sort((a, b) => b[1] - a[1]).slice(0, config.bonusCount).map(([num]) => parseInt(num));
                
            return { numbers, bonus, confidence: (Math.random() * 20 + 70).toFixed(1), scoredNumbers };
        }

        function updatePredictionChart(predictedNumbers, scoredNumbers) {
            const topNumbers = scoredNumbers.sort((a, b) => b.score - a.score).slice(0, 15);
            const labels = topNumbers.map(item => item.num);
            const data = topNumbers.map(item => item.score * 100);
            
            if(charts.predictionVizChart) {
                charts.predictionVizChart.data.labels = labels;
                charts.predictionVizChart.data.datasets[0].data = data;
                charts.predictionVizChart.data.datasets[0].backgroundColor = predictedNumbers.map(num => predictedNumbers.includes(num) ? '#10B981' : '#3B82F6');
                charts.predictionVizChart.update();
            }
        }

        function runCustomPrediction() {
            const model = document.getElementById('predictionModel').value;
            const dataRange = document.getElementById('dataRange').value;
            const focusParams = Array.from(document.querySelectorAll('.focusParam:checked')).map(el => el.value);
            const numPredictions = parseInt(document.getElementById('numPredictions').value) || 5;
            
            if (appState.historicalData.length === 0) {
                showNotification('Load historical data first to run custom prediction!');
                return;
            }
            if (focusParams.length === 0) {
                showNotification('Select at least one focus parameter!');
                return;
            }
            
            const game = document.getElementById('historicalGame').value;
            let config;
            if (game === 'custom') {
                config = {
                    mainPool: parseInt(document.getElementById('historicalMainPool').value) || 69,
                    pickCount: parseInt(document.getElementById('historicalPickCount').value) || 5,
                    bonusPool: parseInt(document.getElementById('historicalBonusPool').value) || 26,
                    bonusCount: parseInt(document.getElementById('historicalBonusCount').value) || 1
                };
            } else {
                config = gameConfigs[game];
            }
            
            let predictions = '';
            for (let i = 1; i <= numPredictions; i++) {
                const prediction = generatePredictionData(config);
                predictions += `<div class="mb-4"><p class="font-medium">Prediction ${i}</p><div class="flex flex-wrap gap-1 my-2">${prediction.numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}${prediction.bonus.map(num => `<span class="number-ball bonus-ball">${num}</span>`).join('')}</div><p class="text-sm">Confidence: ${prediction.confidence}%</p></div>`;
            }
            
            document.getElementById('predictionResults').innerHTML = `<p class="font-medium">Custom Prediction Results</p><p class="text-sm">Model: ${model} | Data Range: ${dataRange} | Focus: ${focusParams.join(', ')}</p>${predictions}`;
            document.getElementById('predictedNumbers').innerHTML = '';
            document.getElementById('confidenceScores').innerHTML = '';
            
            closeModal();
            showNotification('Custom prediction completed!');
        }

        function exportPredictionResults() {
            const predictionResults = document.getElementById('predictionResults').textContent;
            if (predictionResults.includes('Generate predictions')) {
                showNotification('No predictions to export!');
                return;
            }
            
            const blob = new Blob([predictionResults], { type: 'text/plain' });
            downloadBlob(blob, 'prediction_results.txt');
            showNotification('Prediction results exported!');
        }

        // Settings Functions
        function toggleDarkModeSetting(e) {
            appState.darkMode = e.target.checked;
            saveSettings();
            updateUI();
            showNotification(`Dark mode ${appState.darkMode ? 'enabled' : 'disabled'}`);
        }

        function toggleNotificationsSetting(e) {
            appState.notifications = e.target.checked;
            saveSettings();
            showNotification(`Notifications ${appState.notifications ? 'enabled' : 'disabled'}`);
        }

        function toggleAnimationsSetting(e) {
            appState.animations = e.target.checked;
            saveSettings();
            showNotification(`Animations ${appState.animations ? 'enabled' : 'disabled'}`);
        }

        function updateDefaultGame(e) {
            appState.defaultGame = e.target.value;
            saveSettings();
            showNotification(`Default game set to ${appState.defaultGame}`);
        }

        function clearAllData() {
            const confirmReset = (callback) => {
                const modalHtml = `<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center"><h3 class="text-xl font-semibold mb-4">Confirm Reset</h3><p class="mb-6">Are you sure you want to reset all application data? This cannot be undone.</p><div class="flex justify-center gap-4"><button id="confirmCancel" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex-1">Cancel</button><button id="confirmProceed" class="p-2 bg-danger text-white rounded-lg hover:bg-red-600 flex-1">Proceed</button></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                document.getElementById('confirmCancel').addEventListener('click', () => {
                    document.getElementById('confirmModal').remove();
                    callback(false);
                });
                document.getElementById('confirmProceed').addEventListener('click', () => {
                    document.getElementById('confirmModal').remove();
                    callback(true);
                });
            };

            confirmReset((confirmed) => {
                if (confirmed) {
                    localStorage.clear();
                    Object.assign(appState, {
                        historicalData: [], savedTickets: [], notificationCount: 0, currentPage: 1, lastPredictionConfig: null,
                        darkMode: true, animations: true, notifications: true, defaultGame: 'powerball'
                    });
                    
                    clearGenerator();
                    clearAnalyzer();
                    clearHistoricalData();
                    resetProbabilityCalculator();
                    clearReverseEngineer();
                    clearPairsGenerator();
                    clearCombinationsGenerator();
                    
                    document.getElementById('predictionResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Generate predictions to see results</p>';
                    document.getElementById('strategyResults').innerHTML = '<p class="text-gray-500 dark:text-gray-400">Apply a strategy to see recommendations</p>';
                    
                    updateUI();
                    showNotification('All application data has been reset!');
                } else {
                    showNotification('Reset cancelled.');
                }
            });
        }

        function exportAllData() {
            const data = {
                settings: {
                    darkMode: appState.darkMode,
                    animations: appState.animations,
                    notifications: appState.notifications,
                    defaultGame: appState.defaultGame
                },
                historicalData: appState.historicalData,
                savedTickets: appState.savedTickets
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, 'lotto_genius_backup.json');
            showNotification('All application data exported!');
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.settings) Object.assign(appState, data.settings);
                    if (data.historicalData) appState.historicalData = data.historicalData;
                    if (data.savedTickets) appState.savedTickets = data.savedTickets;
                    
                    displayHistoricalData();
                    updateHistoricalCharts();
                    updateUI();
                    showNotification('Application data imported successfully!');
                } catch (err) {
                    showNotification('Error importing data: Invalid file format');
                }
            };
            
            reader.readAsText(file);
            e.target.value = '';
        }

        function saveSettings() {
            localStorage.setItem('lottoGeniusSettings', JSON.stringify({
                darkMode: appState.darkMode,
                animations: appState.animations,
                notifications: appState.notifications,
                defaultGame: appState.defaultGame
            }));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('lottoGeniusSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    Object.assign(appState, settings);
                } catch (err) {
                    console.error('Error loading settings:', err);
                }
            }
        }

        // Utility Functions
        function updateRecentActivity(message) {
            const activityDiv = document.getElementById('recentActivity');
            const now = new Date().toLocaleTimeString();
            
            let html = `<p><span class="text-gray-500 dark:text-gray-400">[${now}]</span> ${message}</p>` + activityDiv.innerHTML;
            
            const paragraphs = html.split('</p>').filter(p => p.trim() !== '');
            if (paragraphs.length > 5) {
                html = paragraphs.slice(0, 5).join('</p>') + '</p>';
            }
            
            activityDiv.innerHTML = html;
        }

        function updateStatsOverview(tickets) {
            if (tickets.length === 0) {
                document.getElementById('statsOverview').innerHTML = '<p>Generate numbers to see statistics</p>';
                return;
            }
            
            const numbers = tickets.flatMap(t => t.numbers);
            const sum = numbers.reduce((a, b) => a + b, 0);
            const avg = sum / numbers.length;
            const oddCount = numbers.filter(n => n % 2 === 1).length;
            const evenCount = numbers.length - oddCount;
            
            document.getElementById('statsOverview').innerHTML = `<p>Numbers Generated: ${numbers.length}</p><p>Average Number: ${avg.toFixed(1)}</p><p>Odd/Even: ${oddCount}/${evenCount}</p>`;
        }

        function handleQuickAction(e) {
            const action = e.target.dataset.action;
            
            switch (action) {
                case 'quickPick':
                    quickPick();
                    break;
                case 'analyzeLast':
                    if (appState.historicalData.length > 0) {
                        const lastDraw = appState.historicalData[appState.historicalData.length - 1];
                        document.getElementById('numbersToAnalyze').value = lastDraw.numbers.join(', ');
                        analyzeNumbers();
                    } else {
                        showNotification('No historical data to analyze!');
                    }
                    break;
                case 'checkOdds':
                    document.getElementById('probability').scrollIntoView({ behavior: 'smooth' });
                    break;
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
